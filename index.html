<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBSE Paper Generator (2025-26)</title>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+Devanagari:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #64748b;
            --accent: #f59e0b;
            --background: #f8fafc;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--background);
            color: var(--text-main);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Aurora Background */
        .aurora {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            background: radial-gradient(circle at 20% 30%, #e0e7ff 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, #fef3c7 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, #f1f5f9 0%, transparent 100%);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .logo-badge {
            display: inline-block;
            padding: 0.5rem 1.5rem;
            background: var(--white);
            border-radius: 9999px;
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
            font-weight: 800;
            font-size: 0.875rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        h1 {
            font-size: 3rem;
            font-weight: 800;
            letter-spacing: -0.025em;
            margin-bottom: 0.5rem;
            color: #0f172a;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.125rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Subject Grid */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        .subject-btn {
            background: var(--white);
            border: 2px solid transparent;
            border-radius: 1rem;
            padding: 1.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow);
        }

        .subject-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            border-color: #e2e8f0;
        }

        .subject-btn.active {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .subject-btn .icon {
            font-size: 2.5rem;
        }

        .subject-btn .name {
            font-weight: 700;
            font-size: 0.95rem;
        }

        /* Actions */
        .actions {
            text-align: center;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.125rem;
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: scale(1.02);
        }

        .btn-primary:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-primary.loading .loading-spinner {
            display: block;
        }

        .btn-primary.loading .btn-text {
            display: none;
        }

        #error-msg {
            color: #dc2626;
            margin-top: 1rem;
            font-weight: 500;
            display: none;
        }

        /* Paper Preview */
        #paper-preview {
            margin-top: 4rem;
            display: none;
        }

        .paper-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            padding: 0.625rem 1.25rem;
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        /* PRINT STYLES */
        .paper {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 15mm 20mm;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            color: #000;
            position: relative;
            font-family: 'Times New Roman', serif;
        }

        .hindi-paper,
        .sanskrit-paper {
            font-family: 'Noto Sans Devanagari', 'Times New Roman', serif;
        }

        .paper-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .board-name {
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .school-name {
            font-size: 16px;
            font-weight: 700;
            margin: 5px 0;
        }

        .exam-title {
            font-size: 15px;
            font-weight: 700;
        }

        .exam-session {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .paper-meta-row {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 13px;
            margin: 5px 0;
        }

        .bordered {
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
        }

        .paper-instructions {
            font-size: 12px;
            margin: 15px 0;
            border: 1px dashed #666;
            padding: 10px;
            border-radius: 4px;
        }

        .paper-instructions h4 {
            text-decoration: underline;
            margin-bottom: 5px;
        }

        .paper-instructions ol {
            padding-left: 20px;
        }

        .section-header {
            text-align: center;
            font-weight: 700;
            background: #f0f0f0;
            margin: 25px 0 15px;
            padding: 4px;
            border: 1px solid #000;
            text-transform: uppercase;
            font-size: 14px;
        }

        .section-info {
            display: block;
            font-size: 11px;
            font-weight: 400;
            text-transform: none;
            margin-top: 2px;
        }

        .question {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
            page-break-inside: avoid;
            position: relative;
        }

        .q-num {
            font-weight: 700;
            min-width: 25px;
        }

        .q-body {
            flex: 1;
            font-size: 13.5px;
            line-height: 1.4;
        }

        .q-marks {
            font-weight: 700;
            font-size: 12px;
            margin-left: 10px;
            white-space: nowrap;
        }

        .mcq-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px 20px;
            margin-top: 8px;
        }

        .mcq-options.single-col {
            grid-template-columns: 1fr;
        }

        .mcq-opt {
            font-size: 12.5px;
            padding: 2px 0;
        }

        .sub-parts {
            margin-top: 6px;
            padding-left: 8px;
        }

        .sub-part {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }

        .sub-part-label {
            font-weight: 600;
            min-width: 22px;
            flex-shrink: 0;
        }

        .sub-part-text {
            flex: 1;
        }

        .sub-part-marks {
            color: #555;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
        }

        .or-divider {
            text-align: center;
            font-weight: 700;
            font-size: 12px;
            color: #888;
            margin: 8px 0;
            font-style: italic;
        }

        .figure-box {
            margin: 15px 0;
            padding: 20px;
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
            color: #666;
        }

        .figure-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #ccc;
        }

        .figure-label {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #444;
            margin-bottom: 5px;
        }

        .q-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #eee;
        }

        .paper-footer {
            text-align: center;
            margin-top: 28px;
            padding-top: 14px;
            border-top: 1.5px solid #999;
            font-size: 11px;
            color: #888;
        }

        @media print {
            body {
                background: white;
            }

            .aurora,
            .paper-actions,
            .logo-badge,
            #selection-view,
            .no-print {
                display: none !important;
            }

            .container {
                padding: 0;
                margin: 0;
                width: 100%;
                max-width: none;
            }

            .paper {
                box-shadow: none;
                margin: 0;
                padding: 10mm;
                width: 100%;
            }

            #paper-preview {
                display: block !important;
                margin: 0;
            }
        }
    </style>
</head>

<body>
    <div class="aurora"></div>

    <div class="container" id="selection-view">
        <header>
            <div class="logo-badge">Study Vault AI</div>
            <h1>CBSE Paper Generator</h1>
            <p class="subtitle">Generate official 2025-26 pattern question papers for Class IX instantly. Strictly
                aligned with the latest rationalised curriculum.</p>
        </header>

        <div class="subject-grid">
            <button class="subject-btn" onclick="selectSubject(this)" data-subject="Maths">
                <span class="icon">üìê</span>
                <span class="name">Maths</span>
            </button>
            <button class="subject-btn" onclick="selectSubject(this)" data-subject="Science">
                <span class="icon">üß™</span>
                <span class="name">Science</span>
            </button>
            <button class="subject-btn" onclick="selectSubject(this)" data-subject="Social Science">
                <span class="icon">üåç</span>
                <span class="name">SST</span>
            </button>
            <button class="subject-btn" onclick="selectSubject(this)" data-subject="English">
                <span class="icon">üìñ</span>
                <span class="name">English</span>
            </button>
            <button class="subject-btn" onclick="selectSubject(this)" data-subject="Hindi">
                <span class="icon">üïâÔ∏è</span>
                <span class="name">Hindi</span>
            </button>
            <button class="subject-btn" onclick="selectSubject(this)" data-subject="Sanskrit">
                <span class="icon">üî±</span>
                <span class="name">Sanskrit</span>
            </button>
            <button class="subject-btn" onclick="selectSubject(this)" data-subject="Computer Science">
                <span class="icon">üíª</span>
                <span class="name">Comp Sci</span>
            </button>
        </div>

        <div class="actions">
            <button class="btn-primary" id="create-btn" onclick="createPaper()" disabled>
                <span class="loading-spinner"></span>
                <span class="btn-text">üöÄ Generate Paper</span>
            </button>
            <div id="error-msg"></div>
        </div>
    </div>

    <div class="container" id="paper-preview">
        <div class="paper-actions">
            <button class="btn-secondary" onclick="window.location.reload()">‚¨ÖÔ∏è Back to Subjects</button>
            <button class="btn-primary" onclick="window.print()">üñ®Ô∏è Print to PDF</button>
        </div>
        <div id="paper-content"></div>
    </div>

    <script>
        // Supabase Initialization
        const supabaseUrl = 'https://wfegooasrtbhpursgcvh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmZWdvb2FzcnRiaHB1cnNnY3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzOTA2NzAsImV4cCI6MjA4Njk2NjY3MH0.vV3vHZR2wqDI8WJ1zgcgJtY0J_eL21SbuE6WqciRN7s';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        let selectedSubject = '';

        const BLUEPRINTS = {
            'Maths': {
                code: '041', fullName: 'Mathematics', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ / Objective Type', perQ: 1, count: 20, diff: 'Easy', note: 'Includes MCQs and Assertion-Reasoning.' },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer (2 marks)', perQ: 2, count: 5, diff: 'Medium', note: 'Answer in not more than 40 words each.', hasOR: 1 },
                    { id: 'C', title: 'Section C', desc: 'Short Answer (3 marks)', perQ: 3, count: 6, diff: 'Medium', note: 'Answer in not more than 60 words each.', hasOR: 1 },
                    { id: 'D', title: 'Section D', desc: 'Long Answer (5 marks)', perQ: 5, count: 4, diff: 'Hard', note: 'Answer in not more than 120 words each.', hasOR: 1 },
                    { id: 'E', title: 'Section E', desc: 'Case Based Questions (4 marks)', perQ: 4, count: 3, diff: 'Hard', note: 'Source/Real-life scenario based questions.' }
                ],
                instructions: ['This question paper contains 38 questions divided into 5 sections ‚Äî A, B, C, D and E.', 'Section A: 20 MCQs of 1 mark each.', 'Section B: 5 VSA questions of 2 marks each.', 'Section C: 6 SA questions of 3 marks each.', 'Section D: 4 LA questions of 5 marks each.', 'Section E: 3 case based questions of 4 marks each.', 'All questions are compulsory. Internal choice provided in some questions.']
            },
            'Science': {
                code: '086', fullName: 'Science', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ / Assertion-Reasoning', perQ: 1, count: 20, diff: 'Easy', note: 'All questions are compulsory.' },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer (2 marks)', perQ: 2, count: 6, diff: 'Medium', note: 'Answer in not more than 40 words each.', hasOR: 1 },
                    { id: 'C', title: 'Section C', desc: 'Short Answer (3 marks)', perQ: 3, count: 7, diff: 'Medium', note: 'Answer in not more than 60 words each.', hasOR: 1 },
                    { id: 'D', title: 'Section D', desc: 'Long Answer (5 marks)', perQ: 5, count: 3, diff: 'Hard', note: 'Answer in not more than 120 words each.', hasOR: 1 },
                    { id: 'E', title: 'Section E', desc: 'Case Based Questions (4 marks)', perQ: 4, count: 3, diff: 'Hard', note: 'Practical based / Case based questions.' }
                ],
                instructions: ['This question paper comprises 39 questions divided into 5 sections ‚Äî A, B, C, D and E.', 'Section A: 20 MCQs of 1 mark each.', 'Section B: 6 questions of 2 marks each.', 'Section C: 7 questions of 3 marks each.', 'Section D: 3 questions of 5 marks each.', 'Section E: 3 case based questions of 4 marks each.', 'All questions are compulsory. Internal choice provided in some questions.']
            },
            'Social Science': {
                code: '087', fullName: 'Social Science', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ (1 mark each)', perQ: 1, count: 20, diff: 'Easy', note: 'MCQs and Assertion-Reasoning.' },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer (2 marks)', perQ: 2, count: 4, diff: 'Medium', note: 'Answer in not more than 40 words each.' },
                    { id: 'C', title: 'Section C', desc: 'Short Answer (3 marks)', perQ: 3, count: 5, diff: 'Medium', note: 'Answer in not more than 60 words each.', hasOR: 2 },
                    { id: 'D', title: 'Section D', desc: 'Long Answer (5 marks)', perQ: 5, count: 4, diff: 'Hard', note: 'Answer in not more than 120 words each.', hasOR: 2 },
                    { id: 'E', title: 'Section E', desc: 'Case Based Questions (4 marks)', perQ: 4, count: 3, diff: 'Hard', note: 'Source/Case based questions.' },
                    { id: 'F', title: 'Section F', desc: 'Map Based Question (5 marks)', perQ: 5, count: 1, diff: 'Medium', note: '2 marks from History and 3 from Geography.' }
                ],
                instructions: ['This question paper comprises 37 questions divided into 6 sections ‚Äî A, B, C, D, E and F.', 'Section A: 20 MCQs of 1 mark each.', 'Section B: 4 VSA questions of 2 marks each.', 'Section C: 5 SA questions of 3 marks each.', 'Section D: 4 LA questions of 5 marks each.', 'Section E: 3 case based questions of 4 marks each.', 'Section F: Map Based Question of 5 marks.', 'All questions are compulsory. Internal choice provided in some questions.']
            },
            'English': {
                code: '184', fullName: 'English Language and Literature', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A ‚Äî Reading Skills', desc: 'Reading Comprehension', perQ: 1, count: 20, diff: 'Easy', note: 'Two unseen passages (10+10 marks).' },
                    { id: 'B', title: 'Section B ‚Äî Writing Skills & Grammar', desc: 'Writing and Grammar', perQ: 0, count: 0, diff: 'Medium', note: '10m Grammar, 10m Creative Writing.', fixedMarks: 20 },
                    { id: 'C', title: 'Section C ‚Äî Literature', desc: 'Language through Literature', perQ: 0, count: 0, diff: 'Hard', note: 'Extracts and Textbook questions.', fixedMarks: 40 }
                ],
                instructions: ['This question paper is divided into three sections ‚Äî A, B and C.', 'Section A: Reading Skills ‚Äî 20 marks', 'Section B: Writing Skills and Grammar ‚Äî 20 marks', 'Section C: Literature ‚Äî 40 marks', 'Candidates must adhere to the word limit strictly.', 'All questions are compulsory.']
            },
            'Hindi': {
                code: '002', fullName: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä ‡§Ö', time: '3 ‡§ò‡§£‡•ç‡§ü‡•á', maxMarks: 80, lang: 'hi',
                sections: [
                    { id: '‡§Ö', title: '‡§ñ‡§£‡•ç‡§° ‡§Ö ‚Äî ‡§¨‡§π‡•Å‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§®', desc: '‡§Ö‡§™‡§†‡§ø‡§§ ‡§è‡§µ‡§Ç ‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£', perQ: 1, count: 40, diff: 'Easy', note: '‡§Ö‡§™‡§†‡§ø‡§§ ‡§¨‡•ã‡§ß ‡§è‡§µ‡§Ç ‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ (40 ‡§Ö‡§Ç‡§ï)' },
                    { id: '‡§¨', title: '‡§ñ‡§£‡•ç‡§° ‡§¨ ‚Äî ‡§µ‡§∞‡•ç‡§£‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§®', desc: '‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§è‡§µ‡§Ç ‡§≤‡•á‡§ñ‡§®', perQ: 0, count: 0, diff: 'Medium', note: '‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï (20 ‡§Ö‡§Ç‡§ï) ‡§è‡§µ‡§Ç ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§≤‡•á‡§ñ‡§® (20 ‡§Ö‡§Ç‡§ï)', fixedMarks: 40 }
                ],
                instructions: ['‡§á‡§∏ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®-‡§™‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§¶‡•ã ‡§ñ‡§£‡•ç‡§° ‡§π‡•à‡§Ç ‚Äî ‡§ñ‡§£‡•ç‡§° ‚Äò‡§Ö‚Äô ‡§î‡§∞ ‡§ñ‡§£‡•ç‡§° ‚Äò‡§¨‚Äô‡•§', '‡§ñ‡§£‡•ç‡§° ‚Äò‡§Ö‚Äô ‡§Æ‡•á‡§Ç ‡§ï‡•á‡§µ‡§≤ ‡§¨‡§π‡•Å‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡•à‡§Ç (40 ‡§Ö‡§Ç‡§ï)‡•§', '‡§ñ‡§£‡•ç‡§° ‚Äò‡§¨‚Äô ‡§Æ‡•á‡§Ç ‡§µ‡§∞‡•ç‡§£‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡•à‡§Ç (40 ‡§Ö‡§Ç‡§ï)‡•§', '‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§∂‡§¨‡•ç‡§¶-‡§∏‡•Ä‡§Æ‡§æ ‡§ï‡§æ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§∞‡§ñ‡•á‡§Ç‡•§', '‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡§Ç‡•§']
            },
            'Sanskrit': {
                code: '122', fullName: '‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç', time: '3 ‡§π‡•ã‡§∞‡§æ‡§É', maxMarks: 80, lang: 'sa',
                sections: [
                    { id: '‡§ï', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ï ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', desc: '‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É ‡•ß‡•¶', perQ: 1, count: 10, diff: 'Easy', note: '‡§è‡§ï‡§™‡§¶‡•á‡§® ‡§™‡•Ç‡§∞‡•ç‡§£‡§µ‡§æ‡§ï‡•ç‡§Ø‡•á‡§® ‡§ö ‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§£‡§ø‡•§' },
                    { id: '‡§ñ', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ñ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï‡§ï‡§æ‡§∞‡•ç‡§Ø‡§Æ‡•ç', desc: '‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É ‡•ß‡•´', perQ: 0, count: 0, diff: 'Hard', note: '‡§™‡§§‡•ç‡§∞‡§≤‡•á‡§ñ‡§®‡§Æ‡•ç, ‡§ï‡§•‡§æ‡§≤‡•á‡§ñ‡§®‡§Æ‡•ç ‡§ö‡•§', fixedMarks: 15 },
                    { id: '‡§ó', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ó ‚Äî ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•Å‡§ï‡•ç‡§§‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡§Æ‡•ç', desc: '‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É ‡•®‡•´', perQ: 1, count: 25, diff: 'Easy', note: '‡§∏‡§®‡•ç‡§ß‡§ø, ‡§ï‡§æ‡§∞‡§ï, ‡§∂‡§¨‡•ç‡§¶‡§∞‡•Ç‡§™, ‡§ß‡§æ‡§§‡•Å‡§∞‡•Ç‡§™‡•§' },
                    { id: '‡§ò', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ò ‚Äî ‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', desc: '‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É ‡•©‡•¶', perQ: 0, count: 0, diff: 'Medium', note: '‡§∂‡•á‡§Æ‡•Å‡§∑‡•Ä ‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡§æ‡§§‡•ç ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§É‡•§', fixedMarks: 30 }
                ],
                instructions: ['‡§á‡§¶‡§Ç ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§™‡§§‡•ç‡§∞‡§Ç ‡§ö‡§§‡•Å‡§∞‡•ç‡§∑‡•Å ‡§ñ‡§£‡•ç‡§°‡•á‡§∑‡•Å ‡§µ‡§ø‡§≠‡§ï‡•ç‡§§‡§Æ‡•ç ‡§Ö‡§∏‡•ç‡§§‡§ø ‚Äî ‡§ï, ‡§ñ, ‡§ó, ‡§ò‡•§', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ï ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç (10 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ñ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï‡§ï‡§æ‡§∞‡•ç‡§Ø‡§Æ‡•ç (15 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ó ‚Äî ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•Å‡§ï‡•ç‡§§‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡§Æ‡•ç (25 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ò ‚Äî ‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç (30 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)', '‡§∏‡§∞‡•ç‡§µ‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§É ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø‡§æ‡§É ‡§∏‡§®‡•ç‡§§‡§ø‡•§']
            },
            'Computer Science': {
                code: '402', fullName: 'Information Technology', time: '2 Hours 30 Minutes', maxMarks: 50,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'Objective Type Questions', perQ: 1, count: 24, diff: 'Easy', note: 'MCQs on Employability Skills and IT. (24 marks)' },
                    { id: 'B', title: 'Section B', desc: 'Subjective Type Questions', perQ: 2, count: 13, diff: 'Medium', note: 'Answer as per word limits. (26 marks)', fixedMarks: 26 }
                ],
                instructions: ['This question paper contains two sections ‚Äî Section A and Section B.', 'Section A: Objective Type Questions (24 marks).', 'Section B: Subjective Type Questions (26 marks).', 'All questions are compulsory. Internal choice provided in Section B.']
            }
        };

        function selectSubject(btn) {
            document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedSubject = btn.dataset.subject;
            document.getElementById('create-btn').disabled = false;
        }
        function shuffle(arr) { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]] } return a }

        // ====== PARSE MCQ OPTIONS ======
        function parseMCQ(text) {
            const optRegex = /\(([A-Da-d])\)\s*([^\(]*?)(?=\([A-Da-d]\)|$)/g;
            const opts = []; let mainQ = text, m;
            const firstOpt = text.search(/\([A-Da-d]\)\s/);
            if (firstOpt > 0) {
                mainQ = text.substring(0, firstOpt).trim();
                const optPart = text.substring(firstOpt);
                while ((m = optRegex.exec(optPart)) !== null) opts.push({ label: m[1].toUpperCase(), text: m[2].trim() });
            }
            return opts.length >= 3 ? { question: mainQ, options: opts } : null;
        }

        // ====== PARSE SUB-PARTS ======
        function parseSubParts(text) {
            const subRegex = /\(([a-z]|[iv]+)\)\s*([^\(]*?)(?=\([a-z]\)|\([iv]+\)|$)/g;
            const parts = []; let mainQ = text;
            const firstSub = text.search(/\([a-z]\)\s/);
            if (firstSub > 0) {
                mainQ = text.substring(0, firstSub).trim();
                const subPart = text.substring(firstSub); let sm;
                while ((sm = subRegex.exec(subPart)) !== null) {
                    let pt = sm[2].trim(), pm = '';
                    const mM = pt.match(/\[(\d+)\]\s*$/);
                    if (mM) { pm = mM[1]; pt = pt.replace(/\[\d+\]\s*$/, '').trim() }
                    parts.push({ label: sm[1], text: pt, marks: pm });
                }
            }
            return parts.length >= 2 ? { question: mainQ, parts: parts } : null;
        }

        // ====== PARSE FIGURE ======
        function parseFigure(text) {
            const imgMatch = text.match(/\[Image:\s*([^\]]+)\]/i);
            const figMatch = text.match(/\[Figure:\s*([^\]]+)\]/i);
            let url = null, caption = null, match = null;

            if (imgMatch) {
                url = imgMatch[1].trim();
                match = imgMatch[0];
            } else if (figMatch) {
                caption = figMatch[1].trim();
                match = figMatch[0];
                if (caption.match(/^https?:\/\//)) { url = caption; caption = "Diagram"; }
            }

            if (match) return { text: text.replace(match, '').trim(), figure: caption, url: url };
            return null;
        }

        // ====== RENDER QUESTION ======
        function renderQuestion(q, num, marks) {
            const rawText = q.question_text || '';
            const fig = parseFigure(rawText);
            const cleanText = fig ? fig.text : rawText;
            const imageUrl = (fig && fig.url) ? fig.url : (q.image_url || '');

            let html = `<div class="question"><span class="q-num">${num}.</span><div class="q-body">`;

            // Try MCQ
            const mcq = parseMCQ(cleanText);
            if (mcq) {
                html += `<div>${mcq.question}</div>`;
                if (fig || imageUrl) {
                    html += `<div class="figure-box">`;
                    if (imageUrl) {
                        html += `<img src="${imageUrl}" class="q-image" alt="Question Diagram">`;
                        if (fig && fig.figure) html += `<div class="figure-label" style="font-size:10px; margin-top:5px">${fig.figure}</div>`;
                    } else {
                        html += `<div class="figure-icon">üñºÔ∏è</div><div class="figure-label">Diagram / Figure</div>${fig.figure}`;
                    }
                    html += `</div>`;
                }
                const longOpts = mcq.options.some(o => o.text.length > 40);
                html += `<div class="mcq-options${longOpts ? ' single-col' : ''}">`;
                mcq.options.forEach(o => { html += `<div class="mcq-opt">(${o.label}) ${o.text}</div>` });
                html += '</div>';
            } else {
                const sub = parseSubParts(cleanText);
                if (sub) {
                    html += `<div>${sub.question}</div>`;
                    if (fig || imageUrl) {
                        html += `<div class="figure-box">`;
                        if (imageUrl) {
                            html += `<img src="${imageUrl}" class="q-image" alt="Question Diagram">`;
                            if (fig && fig.figure) html += `<div class="figure-label" style="font-size:10px; margin-top:5px">${fig.figure}</div>`;
                        } else {
                            html += `<div class="figure-icon">üñºÔ∏è</div><div class="figure-label">Diagram / Figure</div>${fig.figure}`;
                        }
                        html += `</div>`;
                    }
                    html += '<div class="sub-parts">';
                    sub.parts.forEach(p => {
                        html += `<div class="sub-part"><span class="sub-part-label">(${p.label})</span><span class="sub-part-text">${p.text}</span>${p.marks ? `<span class="sub-part-marks">[${p.marks}]</span>` : ''}</div>`;
                    });
                    html += '</div>';
                } else {
                    html += `<div>${cleanText}</div>`;
                    if (fig || imageUrl) {
                        html += `<div class="figure-box">`;
                        if (imageUrl) {
                            html += `<img src="${imageUrl}" class="q-image" alt="Question Diagram">`;
                            if (fig && fig.figure) html += `<div class="figure-label" style="font-size:10px; margin-top:5px">${fig.figure}</div>`;
                        } else {
                            html += `<div class="figure-icon">üñºÔ∏è</div><div class="figure-label">Diagram / Figure</div>${fig.figure}`;
                        }
                        html += `</div>`;
                    }
                }
            }
            html += `</div><span class="q-marks">[${marks}]</span></div>`;
            return html;
        }

        // ====== CREATE PAPER ======
        async function createPaper() {
            const btn = document.getElementById('create-btn');
            const errDiv = document.getElementById('error-msg');
            errDiv.style.display = 'none';
            btn.classList.add('loading'); btn.disabled = true;
            try {
                const bp = BLUEPRINTS[selectedSubject];
                if (!bp) throw new Error('Unknown subject');
                let { data: allQ, error } = await db.from('question_bank').select('*').eq('subject', selectedSubject).limit(2000);
                if (error) throw error;
                if (!allQ || allQ.length === 0) throw new Error(`No questions found for ${selectedSubject}.`);

                // Split by difficulty
                const easyQ = shuffle(allQ.filter(q => (q.difficulty || '').toLowerCase() === 'easy'));
                const medQ = shuffle(allQ.filter(q => (q.difficulty || '').toLowerCase() === 'medium'));
                const hardQ = shuffle(allQ.filter(q => (q.difficulty || '').toLowerCase() === 'hard'));
                const usedIds = new Set();
                let globalQ = 0;

                function pick(pool, n) {
                    const res = [];
                    for (let i = 0; i < n; i++) {
                        const idx = pool.findIndex(q => !usedIds.has(q.id));
                        if (idx !== -1) { usedIds.add(pool[idx].id); res.push(pool.splice(idx, 1)[0]) }
                    }
                    return res;
                }
                function pickAny(n) {
                    let res = pick(easyQ, n);
                    if (res.length < n) res = res.concat(pick(medQ, n - res.length));
                    if (res.length < n) res = res.concat(pick(hardQ, n - res.length));
                    return res;
                }

                const paperEl = document.getElementById('paper-content');
                const isHindi = bp.lang === 'hi'; const isSanskrit = bp.lang === 'sa';
                paperEl.className = `paper${isHindi ? ' hindi-paper' : ''}${isSanskrit ? ' sanskrit-paper' : ''}`;
                let html = '';

                // HEADER
                html += `<div class="paper-header">`;
                html += `<div class="board-name">Central Board of Secondary Education</div>`;
                html += `<div class="school-name">ANNUAL EXAMINATION (2025-26)</div>`;
                html += `<div class="exam-title">${bp.fullName}</div>`;
                html += `<div class="exam-session">Class ‚Äì IX | Subject Code: ${bp.code}</div>`;
                html += `</div>`;
                html += `<div class="paper-meta-row bordered">`;
                html += `<span>${isHindi || isSanskrit ? '‡§∏‡§Æ‡§Ø :' : 'Time Allowed:'} ${bp.time}</span>`;
                html += `<span>${isHindi || isSanskrit ? '‡§™‡•Ç‡§∞‡•ç‡§£‡§æ‡§Ç‡§ï :' : 'Maximum Marks:'} ${bp.maxMarks}</span>`;
                html += `</div>`;

                // INSTRUCTIONS
                html += `<div class="paper-instructions">`;
                html += `<h4>${isHindi ? '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂' : isSanskrit ? '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§æ‡§É' : 'General Instructions'}</h4><ol>`;
                bp.instructions.forEach(i => { html += `<li>${i}</li>` });
                html += '</ol></div>';

                // SECTIONS
                bp.sections.forEach(sec => {
                    html += `<div class="section-header">${sec.title} ‚Äî ${sec.desc}<span class="section-info">${sec.note}</span></div>`;

                    if (sec.count > 0) {
                        let pool = sec.diff === 'Easy' ? easyQ : sec.diff === 'Medium' ? medQ : hardQ;
                        const qs = pick(pool, sec.count);
                        if (qs.length < sec.count) {
                            const remaining = sec.count - qs.length;
                            qs.push(...pickAny(remaining));
                        }

                        // Internal Choice logic
                        let choiceIdx = 0;
                        qs.forEach((q, idx) => {
                            globalQ++;
                            html += renderQuestion(q, globalQ, sec.perQ);
                            if (sec.hasOR && choiceIdx < sec.hasOR && (idx % 2 === 0) && idx < qs.length - 1) {
                                html += `<div class="or-divider">OR</div>`;
                                choiceIdx++;
                            }
                        });
                    } else if (sec.fixedMarks) {
                        html += `<div style="text-align:center; padding: 20px; font-style:italic">Questions for this section are selected based on ${bp.fullName} specific format (${sec.fixedMarks} marks).</div>`;
                    }
                });

                html += `<div class="paper-footer">*** End of Question Paper ‚Äî Study Vault AI ***</div>`;
                paperEl.innerHTML = html;
                document.getElementById('selection-view').style.display = 'none';
                document.getElementById('paper-preview').style.display = 'block';
                window.scrollTo(0, 0);
            } catch (err) {
                console.error(err);
                errDiv.textContent = err.message;
                errDiv.style.display = 'block';
            } finally {
                btn.classList.remove('loading'); btn.disabled = false;
            }
        }
    </script>
</body>

</html>