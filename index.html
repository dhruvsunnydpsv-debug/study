<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBSE Paper Creator | Study Vault</title>
    <meta name="description"
        content="Create authentic CBSE Class 9 question papers with proper format, marking scheme, and subject-specific patterns.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Serif:ital,wght@0,400;0,700;1,400&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #06060b;
            --surface: rgba(255, 255, 255, 0.03);
            --surface-hover: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.16);
            --text: #eeeef2;
            --text-dim: rgba(238, 238, 242, 0.55);
            --text-muted: rgba(238, 238, 242, 0.3);
            --accent: #7c3aed;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Aurora Background */
        .aurora {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        .aurora div {
            position: absolute;
            border-radius: 50%;
            filter: blur(130px);
            opacity: 0.1;
            animation: drift 22s ease-in-out infinite;
        }

        .aurora div:nth-child(1) {
            width: 550px;
            height: 550px;
            background: #7c3aed;
            top: -8%;
            left: -3%;
        }

        .aurora div:nth-child(2) {
            width: 450px;
            height: 450px;
            background: #06b6d4;
            top: 35%;
            right: -8%;
            animation-delay: -8s;
        }

        .aurora div:nth-child(3) {
            width: 400px;
            height: 400px;
            background: #f43f5e;
            bottom: -5%;
            left: 25%;
            animation-delay: -15s;
        }

        @keyframes drift {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(25px, -35px) scale(1.04);
            }

            66% {
                transform: translate(-20px, 25px) scale(0.96);
            }
        }

        .app {
            position: relative;
            z-index: 1;
            max-width: 960px;
            margin: 0 auto;
            padding: 48px 24px 80px;
        }

        #selection-view {
            text-align: center;
        }

        .logo-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 100px;
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.22);
            font-size: 0.68rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #a78bfa;
            margin-bottom: 24px;
        }

        .logo-badge .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .hero-title {
            font-size: clamp(2rem, 5vw, 3.4rem);
            font-weight: 800;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, #f0f0f5 10%, #a78bfa 55%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.15;
            margin-bottom: 10px;
        }

        .hero-sub {
            color: var(--text-dim);
            font-size: 1rem;
            max-width: 520px;
            margin: 0 auto 12px;
            line-height: 1.6;
        }

        .hero-badge {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-bottom: 44px;
            font-weight: 500;
        }

        .form-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 36px 32px;
            max-width: 620px;
            margin: 0 auto;
            text-align: left;
        }

        .form-label {
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 10px;
            display: block;
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 28px;
        }

        .subject-btn {
            padding: 16px 8px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.78rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .subject-btn:hover {
            border-color: var(--border-hover);
            color: var(--text);
            background: var(--surface-hover);
        }

        .subject-btn.active {
            background: rgba(124, 58, 237, 0.12);
            border-color: rgba(124, 58, 237, 0.4);
            color: #c4b5fd;
        }

        .subject-btn .icon {
            font-size: 1.4rem;
        }

        .subject-btn .sub-code {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        .diff-btn {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .diff-btn:hover {
            background: var(--surface-hover);
        }

        .diff-btn.active {
            border-color: #38bdf8;
            background: rgba(56, 189, 248, 0.1);
            color: #7dd3fc;
        }

        .create-btn {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s;
            letter-spacing: 0.01em;
            box-shadow: 0 4px 24px rgba(124, 58, 237, 0.25);
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(124, 58, 237, 0.35);
        }

        .create-btn:active {
            transform: translateY(0);
        }

        .create-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .create-btn .spinner-inline {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        .create-btn.loading .spinner-inline {
            display: inline-block;
        }

        .create-btn.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-msg {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 10px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #f87171;
            font-size: 0.82rem;
            display: none;
        }

        #paper-view {
            display: none;
        }

        .paper-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 22px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            border-color: var(--border-hover);
            color: var(--text);
            background: var(--surface-hover);
        }

        .action-btn.primary {
            background: rgba(124, 58, 237, 0.1);
            border-color: rgba(124, 58, 237, 0.3);
            color: #a78bfa;
        }

        /* PAPER */
        .paper {
            background: #fff;
            color: #111;
            border-radius: 8px;
            padding: 44px 48px;
            font-family: 'Noto Serif', 'Times New Roman', serif;
            font-size: 13px;
            line-height: 1.75;
            max-width: 820px;
            margin: 0 auto;
            box-shadow: 0 8px 48px rgba(0, 0, 0, 0.35);
        }

        .paper.hindi-paper,
        .paper.sanskrit-paper {
            font-family: 'Noto Sans Devanagari', 'Noto Serif', serif;
        }

        .paper-header {
            text-align: center;
            border-bottom: 2.5px solid #111;
            padding-bottom: 14px;
            margin-bottom: 6px;
        }

        .paper-header .board-name {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #444;
            margin-bottom: 2px;
        }

        .paper-header .school-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .paper-header .exam-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .paper-header .exam-session {
            font-size: 11px;
            color: #555;
            margin-bottom: 8px;
        }

        .paper-meta-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #333;
            padding: 4px 0;
        }

        .paper-meta-row.bordered {
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            padding: 6px 0;
            margin-bottom: 6px;
        }

        .paper-instructions {
            margin: 12px 0 20px;
            padding: 12px 16px;
            border: 1.5px solid #999;
            background: #fafafa;
        }

        .paper-instructions h4 {
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            text-align: center;
            text-decoration: underline;
        }

        .paper-instructions ol {
            padding-left: 18px;
        }

        .paper-instructions li {
            font-size: 11.5px;
            margin-bottom: 4px;
            color: #333;
        }

        .section-header {
            font-size: 13px;
            font-weight: 700;
            margin: 28px 0 14px;
            padding: 7px 14px;
            background: #f0f0f0;
            border-left: 3.5px solid #111;
        }

        .section-header .section-info {
            font-weight: 400;
            font-size: 11px;
            color: #555;
            display: block;
            margin-top: 2px;
        }

        .question {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding-left: 4px;
        }

        .q-num {
            font-weight: 700;
            min-width: 30px;
            flex-shrink: 0;
        }

        .q-body {
            flex: 1;
        }

        .q-marks {
            color: #555;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .mcq-options {
            margin-top: 6px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 24px;
        }

        .mcq-options.single-col {
            grid-template-columns: 1fr;
        }

        .mcq-opt {
            font-size: 12.5px;
            padding: 2px 0;
        }

        .sub-parts {
            margin-top: 6px;
            padding-left: 8px;
        }

        .sub-part {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }

        .sub-part-label {
            font-weight: 600;
            min-width: 22px;
            flex-shrink: 0;
        }

        .sub-part-text {
            flex: 1;
        }

        .sub-part-marks {
            color: #555;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
        }

        .or-divider {
            text-align: center;
            font-weight: 700;
            font-size: 12px;
            color: #888;
            margin: 8px 0;
            font-style: italic;
        }

        .figure-box {
            margin: 15px 0;
            padding: 20px;
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
            color: #666;
        }

        .figure-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #ccc;
        }

        .figure-label {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #444;
            margin-bottom: 5px;
        }

        .q-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #eee;
        }

        .paper-footer {
            text-align: center;
            margin-top: 28px;
            padding-top: 14px;
            border-top: 1.5px solid #999;
            font-size: 11px;
            color: #888;
        }

        @media print {
            body {
                background: white;
            }

            .aurora,
            .paper-actions,
            .logo-badge,
            #selection-view,
            .no-print {
                display: none !important;
            }

            .app {
                padding: 0;
                max-width: 100%;
            }

            .paper {
                box-shadow: none;
                border-radius: 0;
                padding: 20px 32px;
            }

            #paper-view {
                display: block !important;
            }

            .section-header {
                break-after: avoid;
            }

            .question {
                break-inside: avoid;
            }
        }

        @media (max-width: 700px) {
            .app {
                padding: 24px 14px 60px;
            }

            .form-card {
                padding: 24px 18px;
            }

            .subject-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .paper {
                padding: 20px 16px;
                font-size: 12px;
            }

            .mcq-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="aurora">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div class="app">
        <div id="selection-view">
            <div class="logo-badge"><span class="dot"></span> CBSE Question Bank</div>
            <h1 class="hero-title">CBSE Question Paper</h1>
            <p class="hero-sub">Authentic CBSE Class IX final exam papers following the 2025-26 rationalised syllabus ‚Äî
                proper sections, marks, and official patterns.</p>
            <p class="hero-badge">Based on CBSE Official Sample Papers ‚Ä¢ Rationalised Syllabus 2025-26</p>

            <div class="form-card">
                <label class="form-label">Step 1: Choose Subject</label>
                <div class="subject-grid" id="subject-grid">
                    <button class="subject-btn" data-subject="Maths" onclick="selectSubject(this)"><span
                            class="icon">œÄ</span>Mathematics<span class="sub-code">041</span></button>
                    <button class="subject-btn" data-subject="Science" onclick="selectSubject(this)"><span
                            class="icon">‚öõ</span>Science<span class="sub-code">086</span></button>
                    <button class="subject-btn" data-subject="Social Science" onclick="selectSubject(this)"><span
                            class="icon">üåç</span>Social Sci<span class="sub-code">087</span></button>
                    <button class="subject-btn" data-subject="English" onclick="selectSubject(this)"><span
                            class="icon">Aa</span>English<span class="sub-code">184</span></button>
                    <button class="subject-btn" data-subject="Hindi" onclick="selectSubject(this)"><span
                            class="icon">‡§Ö</span>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä '‡§Ö'<span class="sub-code">002</span></button>
                    <button class="subject-btn" data-subject="Sanskrit" onclick="selectSubject(this)"><span
                            class="icon">üïâÔ∏è</span>‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç<span class="sub-code">122</span></button>
                    <button class="subject-btn" data-subject="Computer Science" onclick="selectSubject(this)"><span
                            class="icon">üíª</span>IT<span class="sub-code">402</span></button>
                </div>

                <label class="form-label">Step 2: Selection Mode</label>
                <div class="difficulty-selector">
                    <button class="diff-btn active" onclick="selectDifficulty(this, 'Mixed')">Mixed (Balanced)</button>
                    <button class="diff-btn" onclick="selectDifficulty(this, 'Easy')">Easy Level</button>
                    <button class="diff-btn" onclick="selectDifficulty(this, 'Medium')">Medium Level</button>
                    <button class="diff-btn" onclick="selectDifficulty(this, 'Hard')">Hard Level</button>
                </div>

                <button class="create-btn" id="create-btn" onclick="createPaper()" disabled>
                    <span class="spinner-inline"></span>
                    <span class="btn-text">üìÑ Create Question Paper</span>
                </button>
                <div class="error-msg" id="error-msg"></div>
            </div>
        </div>

        <div id="paper-view">
            <div class="paper-actions no-print">
                <button class="action-btn" onclick="goBack()">‚Üê Back</button>
                <button class="action-btn" onclick="createPaper()">üîÑ New Paper</button>
                <button class="action-btn primary" onclick="window.print()">üñ®Ô∏è Print / Save PDF</button>
            </div>
            <div class="paper" id="paper-content"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://wfegooasrtbhpursgcvh.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmZWdvb2FzcnRiaHB1cnNnY3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzOTA2NzAsImV4cCI6MjA4Njk2NjY3MH0.vV3vHZR2wqDI8WJ1zgcgJtY0J_eL21SbuE6WqciRN7s";
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let selectedSubject = null;
        let selectedDifficulty = 'Mixed';

        const BLUEPRINTS = {
            'Maths': {
                code: '041', fullName: 'Mathematics', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ / Assertion-Reasoning', perQ: 1, count: 20, diff: 'Easy', note: '1 mark each. Includes 18 MCQs and 2 A-R Questions.' },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer (VSA-I)', perQ: 2, count: 5, diff: 'Medium', note: '2 marks each. Answer in 30-50 words.', hasOR: 1 },
                    { id: 'C', title: 'Section C', desc: 'Short Answer (SA-II)', perQ: 3, count: 6, diff: 'Medium', note: '3 marks each. Answer in 50-80 words.', hasOR: 1 },
                    { id: 'D', title: 'Section D', desc: 'Long Answer (LA)', perQ: 5, count: 4, diff: 'Hard', note: '5 marks each. Answer in 80-120 words.', hasOR: 1 },
                    { id: 'E', title: 'Section E', desc: 'Case Study / Source Based', perQ: 4, count: 3, diff: 'Hard', note: '4 marks each. 3 Case studies with sub-parts.' }
                ],
                instructions: ['Total 38 questions in five sections A-E.', 'Section A: Q1-20 (1m each).', 'Section B: Q21-25 (2m each).', 'Section C: Q26-31 (3m each).', 'Section D: Q32-35 (5m each).', 'Section E: Q36-38 (4m each) Case Studies.']
            },
            'Science': {
                code: '086', fullName: 'Science', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ (Objective Type)', perQ: 1, count: 20, diff: 'Easy', note: '1 mark each. Includes Assertion-Reasoning.' },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer Questions', perQ: 2, count: 6, diff: 'Medium', note: '2 marks each. Answer in 30-50 words.', hasOR: 2 },
                    { id: 'C', title: 'Section C', desc: 'Short Answer Questions', perQ: 3, count: 7, diff: 'Medium', note: '3 marks each. Answer in 50-80 words.', hasOR: 2 },
                    { id: 'D', title: 'Section D', desc: 'Long Answer Questions', perQ: 5, count: 3, diff: 'Hard', note: '5 marks each. Answer with labelled diagrams.', hasOR: 2 },
                    { id: 'E', title: 'Section E', desc: 'Case Study Based Questions', perQ: 4, count: 3, diff: 'Hard', note: '4 marks each. Assessment based on case scenarios.' }
                ],
                instructions: ['Total 39 questions in five sections.', 'Section A: 20 MCQs.', 'Section B: 6 questions (2m).', 'Section C: 7 questions (3m).', 'Section D: 3 questions (5m).', 'Section E: 3 case-based (4m).']
            },
            'Social Science': {
                code: '087', fullName: 'Social Science', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ (1 mark each)', perQ: 1, count: 20, diff: 'Easy', note: '20 Objective type questions.' },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer (2 marks)', perQ: 2, count: 4, diff: 'Medium', note: 'Answer in 40 words.', hasOR: 1 },
                    { id: 'C', title: 'Section C', desc: 'Short Answer (3 marks)', perQ: 3, count: 5, diff: 'Medium', note: 'Answer in 60 words.', hasOR: 1 },
                    { id: 'D', title: 'Section D', desc: 'Long Answer (5 marks)', perQ: 5, count: 4, diff: 'Hard', note: 'Answer in 120 words.', hasOR: 1 },
                    { id: 'E', title: 'Section E', desc: 'Case Based Questions (4 marks)', perQ: 4, count: 3, diff: 'Hard', note: 'Source/Passage based questions.' },
                    { id: 'F', title: 'Section F', desc: 'Map Based Question (5 marks)', perQ: 5, count: 1, diff: 'Medium', note: '2 marks from History, 3 from Geography.' }
                ],
                instructions: ['Total 37 questions across sections A-F.', 'Map work is compulsory.', 'Section A: Q1-20 (1m).', 'Section B: Q21-24 (2m).', 'Section C: Q25-29 (3m).', 'Section D: Q30-33 (5m).', 'Section E: Q34-36 (4m).', 'Section F: Q37 (Map Work).']
            },
            'English': {
                code: '184', fullName: 'English Language & Literature', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A ‚Äî Reading Skills', desc: '20 Marks', perQ: 1, count: 20, diff: 'Easy', note: 'Two unseen passages (10 marks each).' },
                    { id: 'B', title: 'Section B ‚Äî Writing Skills & Grammar', desc: '20 Marks', perQ: 0, count: 0, diff: 'Medium', note: '10m Grammar, 10m Composition.', fixedMarks: 20 },
                    { id: 'C', title: 'Section C ‚Äî Language through Literature', desc: '40 Marks', perQ: 0, count: 0, diff: 'Hard', note: 'Extracts + Textbook Questions.', fixedMarks: 40 }
                ],
                instructions: ['This paper is divided into three sections A, B & C.', 'Section A: Reading Skills (20m).', 'Section B: Writing Skills & Grammar (20m).', 'Section C: Literature (40m).']
            },
            'Hindi': {
                code: '002', fullName: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä 'A'', time: '3 ‡§ò‡§£‡•ç‡§ü‡•á', maxMarks: 80, lang: 'hi',
                sections: [
                    { id: '‡§Ö', title: '‡§ñ‡§£‡•ç‡§° ‡§Ö ‚Äî ‡§¨‡§π‡•Å‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®', desc: '40 ‡§Ö‡§Ç‡§ï', perQ: 1, count: 40, diff: 'Easy', note: '‡§Ö‡§™‡§†‡§ø‡§§ ‡§ó‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂ ‡§è‡§µ‡§Ç ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§π‡§æ‡§∞‡§ø‡§ï ‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡•§' },
                    { id: '‡§¨', title: '‡§ñ‡§£‡•ç‡§° ‡§¨ ‚Äî ‡§µ‡§∞‡•ç‡§£‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§®', desc: '40 ‡§Ö‡§Ç‡§ï', perQ: 0, count: 0, diff: 'Medium', note: '‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§è‡§µ‡§Ç ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§≤‡•á‡§ñ‡§®‡•§', fixedMarks: 40 }
                ],
                instructions: ['‡§á‡§∏ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®-‡§™‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§¶‡•ã ‡§ñ‡§£‡•ç‡§° ‡§π‡•à‡§Ç: ‡§Ö ‡§î‡§∞ ‡§¨‡•§', '‡§ñ‡§£‡•ç‡§° ‡§Ö ‡§Æ‡•á‡§Ç ‡§¨‡§π‡•Å‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡•à‡§Ç‡•§', '‡§ñ‡§£‡•ç‡§° ‡§¨ ‡§Æ‡•á‡§Ç ‡§µ‡§∞‡•ç‡§£‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡•à‡§Ç‡•§']
            },
            'Sanskrit': {
                code: '122', fullName: '‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç', time: '3 ‡§π‡•ã‡§∞‡§æ‡§É', maxMarks: 80, lang: 'sa',
                sections: [
                    { id: '‡§ï', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ï ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', desc: '‡•ß‡•¶ ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É', perQ: 1, count: 10, diff: 'Easy', note: '‡§è‡§ï‡§™‡§¶‡•á‡§® ‡§™‡•Ç‡§∞‡•ç‡§£‡§µ‡§æ‡§ï‡•ç‡§Ø‡•á‡§® ‡§ö ‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§£‡§ø‡•§' },
                    { id: '‡§ñ', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ñ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï‡§ï‡§æ‡§∞‡•ç‡§Ø‡§Æ‡•ç', desc: '‡•ß‡•´ ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É', perQ: 0, count: 0, diff: 'Hard', note: '‡§™‡§§‡•ç‡§∞‡§≤‡•á‡§ñ‡§®‡§Æ‡•ç, ‡§ï‡§•‡§æ‡§≤‡•á‡§ñ‡§®‡§Æ‡•ç ‡§ö‡•§', fixedMarks: 15 },
                    { id: '‡§ó', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ó ‚Äî ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•Å‡§ï‡•ç‡§§‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡§Æ‡•ç', desc: '‡•®‡•´ ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É', perQ: 1, count: 25, diff: 'Easy', note: '‡§∏‡§®‡•ç‡§ß‡§ø, ‡§∂‡§¨‡•ç‡§¶‡§∞‡•Ç‡§™, ‡§ß‡§æ‡§§‡•Å‡§∞‡•Ç‡§™ ‡§ö‡•§' },
                    { id: '‡§ò', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ò ‚Äî ‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', desc: '‡•©‡•¶ ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É', perQ: 0, count: 0, diff: 'Medium', note: '‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡§æ‡§§‡•ç ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§É‡•§', fixedMarks: 30 }
                ],
                instructions: ['‡§á‡§¶‡§Ç ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§™‡§§‡•ç‡§∞‡§Ç ‡§ö‡§§‡•Å‡§∞‡•ç‡§∑‡•Å ‡§ñ‡§£‡•ç‡§°‡•á‡§∑‡•Å ‡§µ‡§ø‡§≠‡§ï‡•ç‡§§‡§Æ‡•ç ‡§Ö‡§∏‡•ç‡§§‡§ø ‡§ï-‡§ò‡•§', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ï: ‡§Ö‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç‡•§', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ñ: ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï‡§ï‡§æ‡§∞‡•ç‡§Ø‡§Æ‡•ç‡•§', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ó: ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•Å‡§ï‡•ç‡§§‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡§Æ‡•ç‡•§', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ò: ‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç‡•§']
            },
            'Computer Science': {
                code: '402', fullName: 'Information Technology', time: '2:30 Hours', maxMarks: 50,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'Employability Skills (10m)', perQ: 1, count: 10, diff: 'Easy', note: 'Objective questions.' },
                    { id: 'B', title: 'Section B', desc: 'Subject Specific Skills (40m)', perQ: 2, count: 20, diff: 'Medium', note: 'Objective and Short Answers.', fixedMarks: 40 }
                ],
                instructions: ['Total marks 50.', 'Section A contains MCQ/Objective questions.', 'Section B contains Subjective and Objective questions.']
            }
        };

        function selectSubject(btn) {
            document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedSubject = btn.dataset.subject;
            document.getElementById('create-btn').disabled = false;
        }

        function selectDifficulty(btn, level) {
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedDifficulty = level;
        }

        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function parseMCQ(text) {
            const optRegex = /\(([A-Da-d])\)\s*([^\(]*?)(?=\([A-Da-d]\)|$)/g;
            const opts = []; let firstOpt = text.search(/\([A-Da-d]\)\s/);
            if (firstOpt > 0) {
                const mainQ = text.substring(0, firstOpt).trim();
                const optPart = text.substring(firstOpt); let m;
                while ((m = optRegex.exec(optPart)) !== null) opts.push({ label: m[1].toUpperCase(), text: m[2].trim() });
                return { question: mainQ, options: opts };
            }
            return null;
        }

        function parseSubParts(text) {
            const subRegex = /\(([a-z]|[iv]+)\)\s*([^\(]*?)(?=\([a-z]\)|\([iv]+\)|$)/g;
            const parts = []; let firstSub = text.search(/\([a-z]\)\s/);
            if (firstSub > 0) {
                const mainQ = text.substring(0, firstSub).trim();
                const subPart = text.substring(firstSub); let sm;
                while ((sm = subRegex.exec(subPart)) !== null) {
                    let pt = sm[2].trim(), pm = '';
                    const marksMatch = pt.match(/\[(\d+)\]\s*$/);
                    if (marksMatch) { pm = marksMatch[1]; pt = pt.replace(/\[\d+\]\s*$/, '').trim(); }
                    parts.push({ label: sm[1], text: pt, marks: pm });
                }
                return { question: mainQ, parts: parts };
            }
            return null;
        }

        function parseFigure(text) {
            const imgRegex = /\[Image:\s*([^\]]+)\]/i;
            const figRegex = /\[Figure:\s*([^\]]+)\]/i;
            const im = text.match(imgRegex);
            const fm = text.match(figRegex);
            let url = null, caption = null, marker = null;
            if (im) { url = im[1].trim(); marker = im[0]; }
            else if (fm) { caption = fm[1].trim(); marker = fm[0]; if (caption.startsWith('http')) { url = caption; caption = "Diagram"; } }
            if (marker) return { text: text.replace(marker, '').trim(), figure: caption, url: url };
            return null;
        }

        function renderQuestion(q, num, marks) {
            const raw = q.question_text || '';
            const figData = parseFigure(raw);
            const cleanText = figData ? figData.text : raw;
            const url = (figData && figData.url) ? figData.url : (q.image_url || '');

            let html = `<div class="question"><span class="q-num">${num}.</span><div class="q-body">`;

            const mcq = parseMCQ(cleanText);
            if (mcq) {
                html += `<div>${mcq.question}</div>`;
                if (url || (figData && figData.figure)) {
                    html += `<div class="figure-box">`;
                    if (url) html += `<img src="${url}" class="q-image" alt="Diagram">`;
                    if (figData && figData.figure) html += `<div class="figure-label" style="font-size:10px; margin-top:5px">${figData.figure}</div>`;
                    else if (!url) html += `<div class="figure-icon">üñºÔ∏è</div><div class="figure-label">Diagram Plate</div>`;
                    html += `</div>`;
                }
                const singleCol = mcq.options.some(o => o.text.length > 35);
                html += `<div class="mcq-options${singleCol ? ' single-col' : ''}">`;
                mcq.options.forEach(o => { html += `<div class="mcq-opt">(${o.label}) ${o.text}</div>`; });
                html += '</div>';
            } else {
                const sub = parseSubParts(cleanText);
                if (sub) {
                    html += `<div>${sub.question}</div>`;
                    if (url || (figData && figData.figure)) {
                        html += `<div class="figure-box">`;
                        if (url) html += `<img src="${url}" class="q-image" alt="Diagram">`;
                        if (figData && figData.figure) html += `<div class="figure-label" style="font-size:10px; margin-top:5px">${figData.figure}</div>`;
                        else if (!url) html += `<div class="figure-icon">üñºÔ∏è</div><div class="figure-label">Diagram Plate</div>`;
                        html += `</div>`;
                    }
                    html += `<div class="sub-parts">`;
                    sub.parts.forEach(p => {
                        html += `<div class="sub-part"><span class="sub-part-label">(${p.label})</span><span class="sub-part-text">${p.text}</span>${p.marks ? `<span class="sub-part-marks">[${p.marks}]</span>` : ''}</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div>${cleanText}</div>`;
                    if (url || (figData && figData.figure)) {
                        html += `<div class="figure-box">`;
                        if (url) html += `<img src="${url}" class="q-image" alt="Diagram">`;
                        if (figData && figData.figure) html += `<div class="figure-label" style="font-size:10px; margin-top:5px">${figData.figure}</div>`;
                        else if (!url) html += `<div class="figure-icon">üñºÔ∏è</div><div class="figure-label">Diagram Plate</div>`;
                        html += `</div>`;
                    }
                }
            }
            html += `</div><span class="q-marks">[${marks}]</span></div>`;
            return html;
        }

        async function createPaper() {
            const btn = document.getElementById('create-btn');
            const err = document.getElementById('error-msg');
            err.style.display = 'none'; btn.classList.add('loading'); btn.disabled = true;
            try {
                const bp = BLUEPRINTS[selectedSubject];
                const { data: allQ, error } = await db.from('question_bank').select('*').eq('subject', selectedSubject).limit(1500);
                if (error) throw error;
                if (!allQ || allQ.length === 0) throw new Error(`Empty question bank for ${selectedSubject}`);

                let easy = shuffle(allQ.filter(q => (q.difficulty || '').toLowerCase() === 'easy'));
                let med = shuffle(allQ.filter(q => (q.difficulty || '').toLowerCase() === 'medium'));
                let hard = shuffle(allQ.filter(q => (q.difficulty || '').toLowerCase() === 'hard'));

                const used = new Set(); let globalNum = 0;

                function get(pool, n) {
                    const r = [];
                    for (let i = 0; i < n; i++) {
                        const idx = pool.findIndex(x => !used.has(x.id));
                        if (idx !== -1) { used.add(pool[idx].id); r.push(pool.splice(idx, 1)[0]); }
                    }
                    return r;
                }

                function getAny(n) {
                    let r = [];
                    if (selectedDifficulty === 'Easy') r = get(easy, n);
                    else if (selectedDifficulty === 'Medium') r = get(med, n);
                    else if (selectedDifficulty === 'Hard') r = get(hard, n);
                    else r = get(shuffle([...easy, ...med, ...hard]), n);

                    if (r.length < n) r = r.concat(get(shuffle([...easy, ...med, ...hard]), n - r.length));
                    return r;
                }

                const content = document.getElementById('paper-content');
                const isHi = bp.lang === 'hi'; const isSa = bp.lang === 'sa';
                content.className = `paper${isHi ? ' hindi-paper' : ''}${isSa ? ' sanskrit-paper' : ''}`;

                let html = `<div class="paper-header">
                    <div class="board-name">Central Board of Secondary Education</div>
                    <div class="school-name">STUDY VAULT TERMINAL EXAMINATION (2025-26)</div>
                    <div class="exam-title">${bp.fullName} [Class IX]</div>
                    <div class="exam-session">Subject Code: ${bp.code} | Rationalised Curriculum</div>
                </div>
                <div class="paper-meta-row bordered">
                    <span>Time Allowed: ${bp.time}</span>
                    <span>Max Marks: ${bp.maxMarks}</span>
                </div>
                <div class="paper-instructions">
                    <h4>${isHi ? '‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂' : 'General Instructions'}</h4><ol>`;
                bp.instructions.forEach(ins => { html += `<li>${ins}</li>`; });
                html += `</ol></div>`;

                bp.sections.forEach(sec => {
                    html += `<div class="section-header">${sec.title} ‚Äî ${sec.desc}<span class="section-info">${sec.note}</span></div>`;
                    if (sec.count > 0) {
                        const qs = getAny(sec.count);
                        let orCount = 0;
                        qs.forEach((q, idx) => {
                            globalNum++;
                            html += renderQuestion(q, globalNum, sec.perQ);
                            if (sec.hasOR && orCount < sec.hasOR && idx % 2 === 0 && idx < qs.length - 1) {
                                html += `<div class="or-divider">OR</div>`; orCount++;
                            }
                        });
                    } else if (sec.fixedMarks) {
                        html += `<div style="text-align:center; padding:15px; font-style:italic">Questions for this section are evaluated based on fixed weightage of ${sec.fixedMarks} marks according to CBSE 2025-26 pattern.</div>`;
                    }
                });

                html += `<div class="paper-footer">*** End of Question Paper ‚Äî ¬© Study Vault AI 2026 ***</div>`;
                content.innerHTML = html;
                document.getElementById('selection-view').style.display = 'none';
                document.getElementById('paper-view').style.display = 'block';
                window.scrollTo(0, 0);
            } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
            finally { btn.classList.remove('loading'); btn.disabled = false; }
        }

        function goBack() { document.getElementById('paper-view').style.display = 'none'; document.getElementById('selection-view').style.display = 'block'; }
    </script>
</body>

</html>