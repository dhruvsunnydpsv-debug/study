<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBSE Paper Creator | Study Vault</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Serif:ital,wght@0,400;0,700;1,400&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #06060b;
            --surface: rgba(255, 255, 255, 0.03);
            --surface-hover: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.08);
            --text: #eeeef2;
            --text-dim: rgba(238, 238, 242, 0.55);
            --accent: #7c3aed;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .aurora {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        .aurora div {
            position: absolute;
            border-radius: 50%;
            filter: blur(130px);
            opacity: 0.1;
            animation: drift 22s ease-in-out infinite;
        }

        .aurora div:nth-child(1) {
            width: 550px;
            height: 550px;
            background: #7c3aed;
            top: -8%;
            left: -3%;
        }

        .aurora div:nth-child(2) {
            width: 450px;
            height: 450px;
            background: #06b6d4;
            top: 35%;
            right: -8%;
            animation-delay: -8s;
        }

        @keyframes drift {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(25px, -35px) scale(1.04);
            }

            66% {
                transform: translate(-20px, 25px) scale(0.96);
            }
        }

        .app {
            position: relative;
            z-index: 1;
            max-width: 960px;
            margin: 0 auto;
            padding: 48px 24px 80px;
        }

        .hero-title {
            font-size: clamp(2rem, 5vw, 3.4rem);
            font-weight: 800;
            background: linear-gradient(135deg, #f0f0f5 10%, #a78bfa 55%, #06b6d4 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.15;
            margin-bottom: 10px;
            text-align: center;
        }

        .hero-sub {
            color: var(--text-dim);
            text-align: center;
            max-width: 520px;
            margin: 0 auto 44px;
            font-size: 1rem;
        }

        .form-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 36px 32px;
            max-width: 620px;
            margin: 0 auto;
        }

        .form-label {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 15px;
            display: block;
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 28px;
        }

        .subject-btn {
            padding: 15px 5px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .subject-btn:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: var(--surface-hover);
        }

        .subject-btn.active {
            background: rgba(124, 58, 237, 0.15);
            border-color: var(--accent);
            color: white;
        }

        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        .diff-btn {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.7rem;
        }

        .diff-btn.active {
            background: rgba(6, 182, 212, 0.1);
            border-color: #06b6d4;
            color: #67e8f9;
        }

        .create-btn {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: none;
            background: var(--accent);
            color: white;
            font-weight: 700;
            cursor: pointer;
        }

        .create-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #paper-view {
            display: none;
        }

        .paper-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .action-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .paper {
            background: white;
            color: #111;
            padding: 40px 60px;
            border-radius: 5px;
            font-family: 'Noto Serif', serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .paper.hi,
        .paper.sa {
            font-family: 'Noto Sans Devanagari', serif;
        }

        .paper-header {
            text-align: center;
            border-bottom: 2px solid #111;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .exam-title {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .paper-meta {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #ddd;
            padding: 5px 0;
            font-size: 0.85rem;
        }

        .paper-instructions {
            border: 1px solid #111;
            padding: 10px;
            margin: 15px 0;
            font-size: 0.8rem;
            background: #f9f9f9;
        }

        .section-header {
            font-weight: 700;
            background: #eee;
            padding: 5px 10px;
            margin: 20px 0 10px;
            border-left: 4px solid #111;
        }

        .question {
            display: flex;
            margin-bottom: 15px;
        }

        .q-num {
            font-weight: 700;
            width: 30px;
            flex-shrink: 0;
        }

        .q-body {
            flex: 1;
        }

        .q-marks {
            font-weight: 700;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .mcq-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 5px;
        }

        .mcq-options.single-col {
            grid-template-columns: 1fr;
        }

        .figure-box {
            margin: 10px 0;
            text-align: center;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
            background: #fff;
        }

        .q-image {
            max-width: 100%;
            max-height: 250px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .sub-parts {
            margin-top: 5px;
            padding-left: 15px;
        }

        .sub-part {
            display: flex;
            gap: 5px;
            margin-bottom: 3px;
        }

        .or-divider {
            text-align: center;
            font-style: italic;
            font-weight: 700;
            margin: 10px 0;
            color: #555;
        }

        @media print {

            .aurora,
            .paper-actions,
            .hero-title,
            .hero-sub,
            .form-card {
                display: none !important;
            }

            .paper {
                box-shadow: none;
                padding: 0;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .app {
                padding: 24px 12px 60px;
            }

            .hero-title {
                font-size: 1.6rem;
            }

            .hero-sub {
                font-size: 0.85rem;
                margin-bottom: 24px;
            }

            .form-card {
                padding: 20px 16px;
            }

            .subject-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .difficulty-selector {
                grid-template-columns: repeat(2, 1fr);
            }

            .paper {
                padding: 20px 16px;
                font-size: 0.85rem;
            }

            .paper-header {
                padding-bottom: 8px;
            }

            .exam-title {
                font-size: 1rem;
            }

            .question {
                flex-wrap: wrap;
            }

            .q-image {
                max-height: 180px;
            }

            .mcq-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 400px) {
            .subject-grid {
                grid-template-columns: 1fr 1fr;
            }

            .paper {
                padding: 12px 10px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="aurora">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div class="app">
        <div id="selection-view">
            <h1 class="hero-title">CBSE Paper Creator</h1>
            <p class="hero-sub">Premium 2025-26 Academic Year ‚Ä¢ Logic Fixed ‚Ä¢ Diagrams Verified</p>
            <div class="form-card">
                <label class="form-label">1. Select Subject</label>
                <div class="subject-grid">
                    <button class="subject-btn" onclick="setSubject(this, 'Maths')">œÄ Maths</button>
                    <button class="subject-btn" onclick="setSubject(this, 'Science')">‚öõ Science</button>
                    <button class="subject-btn" onclick="setSubject(this, 'Social Science')">üåç SST</button>
                    <button class="subject-btn" onclick="setSubject(this, 'English')">Aa English</button>
                    <button class="subject-btn" onclick="setSubject(this, 'Hindi')">‡§Ö ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
                    <button class="subject-btn" onclick="setSubject(this, 'Sanskrit')">üïâ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç</button>
                </div>
                <label class="form-label">2. Difficulty Level</label>
                <div class="difficulty-selector">
                    <button class="diff-btn active" onclick="setDiff(this, 'Mixed')">Mixed</button>
                    <button class="diff-btn" onclick="setDiff(this, 'Easy')">Easy</button>
                    <button class="diff-btn" onclick="setDiff(this, 'Medium')">Medium</button>
                    <button class="diff-btn" onclick="setDiff(this, 'Hard')">Hard</button>
                </div>
                <button class="create-btn" id="create-btn" onclick="createPaper()" disabled>Generate Question
                    Paper</button>
                <div id="error-msg" style="color:#f87171; margin-top:10px; font-size:0.8rem; display:none;"></div>
            </div>
        </div>
        <div id="paper-view">
            <div class="paper-actions">
                <button class="action-btn" onclick="location.reload()">‚Üê Restart</button>
                <button class="action-btn" onclick="window.print()"
                    style="background:var(--accent); color:white; border:none;">Print Paper</button>
            </div>
            <div id="paper-content"></div>
        </div>
    </div>

    <script>
        const db = window.supabase.createClient("https://wfegooasrtbhpursgcvh.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmZWdvb2FzcnRiaHB1cnNnY3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzOTA2NzAsImV4cCI6MjA4Njk2NjY3MH0.vV3vHZR2wqDI8WJ1zgcgJtY0J_eL21SbuE6WqciRN7s");
        let selectedGrade = 9; let selectedSubject = null; let selectedDiff = 'Mixed';

        const BLUEPRINTS = {
            'Maths': {
                code: '041', fullName: 'Mathematics', time: '3h', maxMarks: 80, sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ (1m)', perQ: 1, count: 20 },
                    { id: 'B', title: 'Section B', desc: 'Short Answer I (SA-I) (2m)', perQ: 2, count: 5 },
                    { id: 'C', title: 'Section C', desc: 'Short Answer II (SA-II) (3m)', perQ: 3, count: 6 },
                    { id: 'D', title: 'Section D', desc: 'LA (5m)', perQ: 5, count: 4 },
                    { id: 'E', title: 'Section E', desc: 'Case Study (4m)', perQ: 4, count: 3 }
                ], inst: ['38 questions.', 'Sections A-E.', 'Map work not required.']
            },
            'Science': {
                code: '086', fullName: 'Science', time: '3h', maxMarks: 80, sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ (1m)', perQ: 1, count: 20 },
                    { id: 'B', title: 'Section B', desc: 'VSA (2m)', perQ: 2, count: 6 },
                    { id: 'C', title: 'Section C', desc: 'SA (3m)', perQ: 3, count: 7 },
                    { id: 'D', title: 'Section D', desc: 'LA (5m)', perQ: 5, count: 3 },
                    { id: 'E', title: 'Section E', desc: 'Case Based (4m)', perQ: 4, count: 3 }
                ], inst: ['39 questions.', 'Sections A-E.', 'Label diagrams wherever necessary.']
            },
            'Social Science': {
                code: '087', fullName: 'Social Science', time: '3h', maxMarks: 80, sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ (1m)', perQ: 1, count: 20 },
                    { id: 'B', title: 'Section B', desc: 'VSA (2m)', perQ: 2, count: 4 },
                    { id: 'C', title: 'Section C', desc: 'SA (3m)', perQ: 3, count: 5 },
                    { id: 'D', title: 'Section D', desc: 'LA (5m)', perQ: 5, count: 4 },
                    { id: 'E', title: 'Section E', desc: 'Case Based (4m)', perQ: 4, count: 3 },
                    { id: 'F', title: 'Section F', desc: 'Map Based (5m)', perQ: 5, count: 1 }
                ], inst: ['37 questions.', 'Map is compulsory.']
            },
            'English': {
                code: '184', fullName: 'English Literature', time: '3h', maxMarks: 80, sections: [
                    { id: 'A', title: 'Section A', desc: 'Reading Skills (20m)', perQ: 1, count: 20 },
                    { id: 'B', title: 'Section B', desc: 'Writing/Grammar (20m)', perQ: 0, count: 0, fixed: 20 },
                    { id: 'C', title: 'Section C', desc: 'Literature (40m)', perQ: 0, count: 0, fixed: 40 }
                ], inst: ['Three sections A, B, C.']
            },
            'Hindi': {
                code: '002', fullName: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä ‡§ï‡•ã‡§∞‡•ç‡§∏ \'‡§Ö\'', time: '3h', maxMarks: 80, lang: 'hi', sections: [
                    { id: '‡§Ö', title: '‡§ñ‡§£‡•ç‡§° ‡§Ö ‚Äî ‡§¨‡§π‡•Å‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•Ä‡§Ø', perQ: 1, count: 40 },
                    { id: '‡§¨', title: '‡§ñ‡§£‡•ç‡§° ‡§¨ ‚Äî ‡§µ‡§∞‡•ç‡§£‡§®‡§æ‡§§‡•ç‡§Æ‡§ï', perQ: 0, count: 0, fixed: 40 }
                ], inst: ['‡§¶‡•ã ‡§ñ‡§£‡•ç‡§° ‡§Ö ‡§î‡§∞ ‡§¨ ‡•§']
            },
            'Sanskrit': {
                code: '122', fullName: '‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç', time: '3h', maxMarks: 80, lang: 'sa', sections: [
                    { id: '‡§ï', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ï ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', perQ: 1, count: 10 },
                    { id: '‡§ñ', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ñ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï‡§ï‡§æ‡§∞‡•ç‡§Ø‡§Æ‡•ç', perQ: 0, count: 0, fixed: 15 },
                    { id: '‡§ó', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ó ‚Äî ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•Å‡§ï‡•ç‡§§‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡§Æ‡•ç', perQ: 1, count: 25 },
                    { id: '‡§ò', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ò ‚Äî ‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', perQ: 0, count: 0, fixed: 30 }
                ], inst: ['‡§ö‡§§‡•ç‡§µ‡§æ‡§∞‡§É ‡§ñ‡§£‡•ç‡§°‡§æ‡§É ‡§∏‡§®‡•ç‡§§‡§ø ‡•§']
            }
        };

        function setSubject(btn, s) {
            document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); selectedSubject = s;
            document.getElementById('create-btn').disabled = false;
        }
        function setDiff(btn, d) {
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); selectedDiff = d;
        }

        function parseFig(text) {
            const imgM = text.match(/\[Image:\s*([^\]]+)\]/i);
            const figM = text.match(/\[Figure:\s*([^\]]+)\]/i);
            const m = imgM || figM;
            if (m) return { url: m[1].trim(), clean: text.replace(m[0], '').trim() };
            return { url: null, clean: text };
        }

        function renderQ(q, num, marks) {
            const raw = q.question_text || '';
            const fig = parseFig(raw);
            let url = fig.url || q.image_url;
            let text = fig.clean;

            let html = `<div class="question"><span class="q-num">${num}.</span><div class="q-body">`;

            // Render Image at the top of the body for visibility
            if (url) {
                html += `<div class="figure-box"><img src="${url}" class="q-image" alt="Diagram Content" onerror="this.parentElement.innerHTML='<div style=\'color:#888;font-size:0.7rem\'>Diagram failed to load from source</div>'"></div>`;
            }

            // Check for MCQ
            const hasMCQ = text.includes('(A)') && text.includes('(B)');
            if (hasMCQ) {
                const parts = text.split('(A)');
                const mainText = parts[0].trim();
                const options = ('(A)' + (parts[1] || '')).match(/\([A-D]\)[^\(]*/g);

                html += `<div>${mainText}</div>`;
                if (options) {
                    html += `<div class="mcq-options${options.some(o => o.length > 35) ? ' single-col' : ''}">`;
                    options.forEach(o => html += `<div class="mcq-opt">${o.trim()}</div>`);
                    html += `</div>`;
                }
            } else if (text.includes('(a)') && text.includes('(b)')) {
                // Sub-parts
                const mainText = text.split('(a)')[0].trim();
                const subs = text.substring(mainText.length).match(/\([a-z]\)[^\(]*/g);

                html += `<div>${mainText}</div>`;
                if (subs) {
                    html += `<div class="sub-parts">`;
                    subs.forEach(s => html += `<div class="sub-part">${s.trim()}</div>`);
                    html += `</div>`;
                }
            } else {
                html += `<div>${text}</div>`;
            }

            html += `</div><span class="q-marks">[${marks}]</span></div>`;
            return html;
        }

        async function createPaper() {
            const btn = document.getElementById('create-btn'); const err = document.getElementById('error-msg');
            btn.disabled = true; btn.textContent = 'Generating...'; err.style.display = 'none';
            try {
                const bp = BLUEPRINTS[selectedSubject];
                // Query BOTH plain subject name AND composite (Subject_9) to catch all data
                const [r1, r2] = await Promise.all([
                    db.from('question_bank').select('*').eq('subject', selectedSubject).limit(1000),
                    db.from('question_bank').select('*').eq('subject', `${selectedSubject}_${selectedGrade}`).limit(1000)
                ]);
                if (r1.error) throw r1.error;
                const allQ = [...(r1.data || []), ...(r2.data || [])];
                if (allQ.length === 0) throw new Error(`No questions found for ${selectedSubject}. The database may be empty.`);
                const pool = allQ.sort(() => Math.random() - 0.5);

                let html = `<div class="paper ${bp.lang || ''}">
                    <div class="paper-header">
                        <div style="font-size:0.7rem; letter-spacing:0.1em; color:#666">CENTRAL BOARD OF SECONDARY EDUCATION</div>
                        <div class="exam-title">${bp.fullName} - Class IX</div>
                        <div style="font-size:0.8rem">Study Vault | Academic Year 2025-26</div>
                    </div>
                    <div class="paper-meta"><span>Time: ${bp.time}</span><span>Marks: ${bp.maxMarks}</span></div>
                    <div class="paper-instructions"><strong>General Instructions:</strong><ul>`;
                bp.inst.forEach(i => html += `<li>${i}</li>`);
                html += `</ul></div>`;

                let gNum = 0; let used = new Set();
                bp.sections.forEach(sec => {
                    html += `<div class="section-header">${sec.title} ‚Äî ${sec.desc || ''}</div>`;
                    if (sec.count > 0) {
                        // DIAGRAM BIAS: Prioritize questions with [Image: for Case Studies and Science D
                        let sectionPool = pool.filter(q => !used.has(q.id));
                        if (sec.id === 'E' || (selectedSubject === 'Science' && sec.id === 'D')) {
                            const diagPool = sectionPool.filter(q => q.question_text.includes('[Image:') || q.image_url);
                            const otherPool = sectionPool.filter(q => !(q.question_text.includes('[Image:') || q.image_url));
                            sectionPool = [...diagPool, ...otherPool];
                        }

                        let count = 0;
                        for (let q of sectionPool) {
                            if (selectedDiff !== 'Mixed' && q.difficulty !== selectedDiff) continue;
                            gNum++; count++; used.add(q.id);
                            html += renderQ(q, gNum, sec.perQ);
                            if (count >= sec.count) break;
                        }
                    } else if (sec.fixed) {
                        html += `<div style="text-align:center; padding:10px; font-style:italic">Questions worth ${sec.fixed} marks from prescribed text and grammar.</div>`;
                    }
                });
                html += `</div>`;
                document.getElementById('paper-content').innerHTML = html;
                document.getElementById('selection-view').style.display = 'none';
                document.getElementById('paper-view').style.display = 'block';
            } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
            finally { btn.disabled = false; btn.textContent = 'Generate Question Paper'; }
        }
    </script>
</body>

</html>