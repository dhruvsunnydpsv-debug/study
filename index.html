<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBSE Paper Creator | Study Vault</title>
    <meta name="description"
        content="Create authentic CBSE Class 9 question papers with proper format, marking scheme, and subject-specific patterns.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Serif:ital,wght@0,400;0,700;1,400&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #06060b;
            --surface: rgba(255, 255, 255, 0.03);
            --surface-hover: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.16);
            --text: #eeeef2;
            --text-dim: rgba(238, 238, 242, 0.55);
            --text-muted: rgba(238, 238, 242, 0.3);
            --accent: #7c3aed
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden
        }

        .aurora {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none
        }

        .aurora div {
            position: absolute;
            border-radius: 50%;
            filter: blur(130px);
            opacity: 0.1;
            animation: drift 22s ease-in-out infinite
        }

        .aurora div:nth-child(1) {
            width: 550px;
            height: 550px;
            background: #7c3aed;
            top: -8%;
            left: -3%
        }

        .aurora div:nth-child(2) {
            width: 450px;
            height: 450px;
            background: #06b6d4;
            top: 35%;
            right: -8%;
            animation-delay: -8s
        }

        .aurora div:nth-child(3) {
            width: 400px;
            height: 400px;
            background: #f43f5e;
            bottom: -5%;
            left: 25%;
            animation-delay: -15s
        }

        @keyframes drift {

            0%,
            100% {
                transform: translate(0, 0) scale(1)
            }

            33% {
                transform: translate(25px, -35px) scale(1.04)
            }

            66% {
                transform: translate(-20px, 25px) scale(0.96)
            }
        }

        .app {
            position: relative;
            z-index: 1;
            max-width: 960px;
            margin: 0 auto;
            padding: 48px 24px 80px
        }

        #selection-view {
            text-align: center
        }

        .logo-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 100px;
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.22);
            font-size: 0.68rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #a78bfa;
            margin-bottom: 24px
        }

        .logo-badge .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s ease-in-out infinite
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.3
            }
        }

        .hero-title {
            font-size: clamp(2rem, 5vw, 3.4rem);
            font-weight: 800;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, #f0f0f5 10%, #a78bfa 55%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.15;
            margin-bottom: 10px
        }

        .hero-sub {
            color: var(--text-dim);
            font-size: 1rem;
            max-width: 520px;
            margin: 0 auto 12px;
            line-height: 1.6
        }

        .hero-badge {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-bottom: 44px;
            font-weight: 500
        }

        .form-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 36px 32px;
            max-width: 620px;
            margin: 0 auto;
            text-align: left
        }

        .form-label {
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 10px;
            display: block
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 28px
        }

        .subject-btn {
            padding: 16px 8px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.78rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px
        }

        .subject-btn:hover {
            border-color: var(--border-hover);
            color: var(--text);
            background: var(--surface-hover)
        }

        .subject-btn.active {
            background: rgba(124, 58, 237, 0.12);
            border-color: rgba(124, 58, 237, 0.4);
            color: #c4b5fd
        }

        .subject-btn .icon {
            font-size: 1.4rem
        }

        .subject-btn .sub-code {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 2px
        }

        .create-btn {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s;
            letter-spacing: 0.01em;
            box-shadow: 0 4px 24px rgba(124, 58, 237, 0.25)
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(124, 58, 237, 0.35)
        }

        .create-btn:active {
            transform: translateY(0)
        }

        .create-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none
        }

        .create-btn .spinner-inline {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            vertical-align: middle;
            margin-right: 8px
        }

        .create-btn.loading .spinner-inline {
            display: inline-block
        }

        .create-btn.loading .btn-text {
            display: none
        }

        .create-btn.loading .btn-loading {
            display: inline
        }

        .btn-loading {
            display: none
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .error-msg {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 10px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #f87171;
            font-size: 0.82rem;
            display: none
        }

        #paper-view {
            display: none
        }

        .paper-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 28px;
            flex-wrap: wrap
        }

        .action-btn {
            padding: 10px 22px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s
        }

        .action-btn:hover {
            border-color: var(--border-hover);
            color: var(--text);
            background: var(--surface-hover)
        }

        .action-btn.primary {
            background: rgba(124, 58, 237, 0.1);
            border-color: rgba(124, 58, 237, 0.3);
            color: #a78bfa
        }

        /* PAPER */
        .paper {
            background: #fff;
            color: #111;
            border-radius: 8px;
            padding: 44px 48px;
            font-family: 'Noto Serif', 'Times New Roman', serif;
            font-size: 13px;
            line-height: 1.75;
            max-width: 820px;
            margin: 0 auto;
            box-shadow: 0 8px 48px rgba(0, 0, 0, 0.35)
        }

        .paper.hindi-paper,
        .paper.sanskrit-paper {
            font-family: 'Noto Sans Devanagari', 'Noto Serif', serif
        }

        .paper-header {
            text-align: center;
            border-bottom: 2.5px solid #111;
            padding-bottom: 14px;
            margin-bottom: 6px
        }

        .paper-header .board-name {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #444;
            margin-bottom: 2px
        }

        .paper-header .school-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px
        }

        .paper-header .exam-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 4px
        }

        .paper-header .exam-session {
            font-size: 11px;
            color: #555;
            margin-bottom: 8px
        }

        .paper-meta-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #333;
            padding: 4px 0
        }

        .paper-meta-row.bordered {
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            padding: 6px 0;
            margin-bottom: 6px
        }

        .paper-instructions {
            margin: 12px 0 20px;
            padding: 12px 16px;
            border: 1.5px solid #999;
            background: #fafafa
        }

        .paper-instructions h4 {
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            text-align: center;
            text-decoration: underline
        }

        .paper-instructions ol {
            padding-left: 18px
        }

        .paper-instructions li {
            font-size: 11.5px;
            margin-bottom: 4px;
            color: #333
        }

        .section-header {
            font-size: 13px;
            font-weight: 700;
            margin: 28px 0 14px;
            padding: 7px 14px;
            background: #f0f0f0;
            border-left: 3.5px solid #111
        }

        .section-header .section-info {
            font-weight: 400;
            font-size: 11px;
            color: #555;
            display: block;
            margin-top: 2px
        }

        .question {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding-left: 4px
        }

        .q-num {
            font-weight: 700;
            min-width: 30px;
            flex-shrink: 0
        }

        .q-body {
            flex: 1
        }

        .q-marks {
            color: #555;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            margin-left: 8px;
            flex-shrink: 0
        }

        .mcq-options {
            margin-top: 6px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 24px
        }

        .mcq-options.single-col {
            grid-template-columns: 1fr
        }

        .mcq-opt {
            font-size: 12.5px;
            padding: 2px 0
        }

        .sub-parts {
            margin-top: 6px;
            padding-left: 8px
        }

        .sub-part {
            display: flex;
            gap: 6px;
            margin-bottom: 6px
        }

        .sub-part-label {
            font-weight: 600;
            min-width: 22px;
            flex-shrink: 0
        }

        .sub-part-text {
            flex: 1
        }

        .sub-part-marks {
            color: #555;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap
        }

        .or-divider {
            text-align: center;
            font-weight: 700;
            font-size: 12px;
            color: #888;
            margin: 8px 0;
            font-style: italic
        }

        .figure-box {
            margin: 8px 0;
            padding: 12px 16px;
            border: 1.5px dashed #aaa;
            border-radius: 4px;
            background: #f9f9f9;
            text-align: center;
            color: #555;
            font-size: 11px;
            font-style: italic
        }

        .paper-footer {
            text-align: center;
            margin-top: 28px;
            padding-top: 14px;
            border-top: 1.5px solid #999;
            font-size: 11px;
            color: #888
        }

        @media print {
            body {
                background: white
            }

            .aurora,
            .paper-actions,
            .logo-badge,
            #selection-view,
            .no-print {
                display: none !important
            }

            .app {
                padding: 0;
                max-width: 100%
            }

            .paper {
                box-shadow: none;
                border-radius: 0;
                padding: 20px 32px
            }

            #paper-view {
                display: block !important
            }

            .section-header {
                break-after: avoid
            }

            .question {
                break-inside: avoid
            }
        }

        @media(max-width:700px) {
            .app {
                padding: 24px 14px 60px
            }

            .form-card {
                padding: 24px 18px
            }

            .subject-grid {
                grid-template-columns: repeat(2, 1fr)
            }

            .paper {
                padding: 20px 16px;
                font-size: 12px
            }

            .mcq-options {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="aurora">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div class="app">
        <div id="selection-view">
            <div class="logo-badge"><span class="dot"></span> CBSE Question Bank</div>
            <h1 class="hero-title">CBSE Question Paper</h1>
            <p class="hero-sub">Authentic CBSE Class IX final exam papers following the 2024-25 rationalised syllabus ‚Äî
                proper sections, marks, chapter weightage.</p>
            <p class="hero-badge">Based on CBSE Official Sample Papers ‚Ä¢ Rationalised Syllabus 2024-25</p>
            <div class="form-card">
                <label class="form-label">Choose Subject</label>
                <div class="subject-grid" id="subject-grid">
                    <button class="subject-btn" data-subject="Maths" onclick="selectSubject(this)"><span
                            class="icon">œÄ</span>Mathematics<span class="sub-code">041</span></button>
                    <button class="subject-btn" data-subject="Science" onclick="selectSubject(this)"><span
                            class="icon">‚öõ</span>Science<span class="sub-code">086</span></button>
                    <button class="subject-btn" data-subject="Social Science" onclick="selectSubject(this)"><span
                            class="icon">üåç</span>Social Sci<span class="sub-code">087</span></button>
                    <button class="subject-btn" data-subject="English" onclick="selectSubject(this)"><span
                            class="icon">Aa</span>English<span class="sub-code">184</span></button>
                    <button class="subject-btn" data-subject="Hindi" onclick="selectSubject(this)"><span
                            class="icon">‡§Ö</span>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä '‡§Ö'<span class="sub-code">002</span></button>
                    <button class="subject-btn" data-subject="Sanskrit" onclick="selectSubject(this)"><span
                            class="icon">üïâÔ∏è</span>‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç<span class="sub-code">122</span></button>
                    <button class="subject-btn" data-subject="Computer Science" onclick="selectSubject(this)"><span
                            class="icon">üíª</span>IT<span class="sub-code">402</span></button>
                </div>
                <button class="create-btn" id="create-btn" onclick="createPaper()" disabled>
                    <span class="spinner-inline"></span>
                    <span class="btn-text">üìÑ Create Question Paper</span>
                    <span class="btn-loading">Creating Paper...</span>
                </button>
                <div class="error-msg" id="error-msg"></div>
            </div>
        </div>
        <div id="paper-view">
            <div class="paper-actions no-print">
                <button class="action-btn" onclick="goBack()">‚Üê Back</button>
                <button class="action-btn" onclick="createPaper()">üîÑ New Paper</button>
                <button class="action-btn primary" onclick="window.print()">üñ®Ô∏è Print / Save PDF</button>
            </div>
            <div class="paper" id="paper-content"></div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = "https://wfegooasrtbhpursgcvh.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmZWdvb2FzcnRiaHB1cnNnY3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzOTA2NzAsImV4cCI6MjA4Njk2NjY3MH0.vV3vHZR2wqDI8WJ1zgcgJtY0J_eL21SbuE6WqciRN7s";
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let selectedSubject = null;

        // ====== SUBJECT BLUEPRINTS ======
        const BLUEPRINTS = {
            'Maths': {
                code: '041', fullName: 'Mathematics', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'Objective Type Questions (MCQ)', perQ: 1, count: 20, diff: 'Easy', note: 'All questions are compulsory. Each carries 1 mark.' },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer Type Questions (VSA)', perQ: 2, count: 5, diff: 'Medium', note: 'Answer in 30-50 words. Internal choice in 2 questions.', hasOR: 2 },
                    { id: 'C', title: 'Section C', desc: 'Short Answer Type Questions (SA)', perQ: 3, count: 6, diff: 'Medium', note: 'Answer in 50-80 words. Internal choice in 2 questions.', hasOR: 2 },
                    { id: 'D', title: 'Section D', desc: 'Long Answer Type Questions (LA)', perQ: 5, count: 4, diff: 'Hard', note: 'Answer in 80-120 words. Internal choice in 2 questions.', hasOR: 2 },
                    { id: 'E', title: 'Section E', desc: 'Case Study Based Questions', perQ: 4, count: 3, diff: 'Hard', note: 'Each case has sub-parts.' }
                ],
                instructions: ['This question paper contains 38 questions divided into 5 sections ‚Äî A, B, C, D and E.', 'Section A comprises 20 MCQs carrying 1 mark each.', 'Section B comprises 5 questions carrying 2 marks each.', 'Section C comprises 6 questions carrying 3 marks each.', 'Section D comprises 4 questions carrying 5 marks each.', 'Section E comprises 3 case study based questions carrying 4 marks each.', 'Internal choice has been provided in 2 questions in Section B, 2 in Section C, 2 in Section D.', 'Draw neat figures wherever required. Use of calculator is not permitted.']
            },
            'Science': {
                code: '086', fullName: 'Science', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ / Objective Type', perQ: 1, count: 20, diff: 'Easy', note: 'All questions are compulsory.' },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer Questions', perQ: 2, count: 6, diff: 'Medium', note: 'Answer in 30-50 words.', hasOR: 2 },
                    { id: 'C', title: 'Section C', desc: 'Short Answer Questions', perQ: 3, count: 7, diff: 'Medium', note: 'Answer in 50-80 words.', hasOR: 2 },
                    { id: 'D', title: 'Section D', desc: 'Long Answer Questions', perQ: 5, count: 3, diff: 'Hard', note: 'Answer in 80-120 words with diagrams.', hasOR: 2 },
                    { id: 'E', title: 'Section E', desc: 'Case Based Questions', perQ: 4, count: 3, diff: 'Hard', note: 'Read the passage and answer sub-questions.' }
                ],
                instructions: ['This question paper contains 39 questions divided into 5 sections.', 'Section A: 20 MCQs of 1 mark each.', 'Section B: 6 VSA questions of 2 marks each (30-50 words).', 'Section C: 7 SA questions of 3 marks each (50-80 words).', 'Section D: 3 LA questions of 5 marks each (80-120 words).', 'Section E: 3 case-based questions of 4 marks each.', 'Draw neat and labelled diagrams wherever necessary.', 'All questions are compulsory. Internal choice is provided in some questions.']
            },
            'Social Science': {
                code: '087', fullName: 'Social Science', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'MCQ / Objective Type', perQ: 1, count: 20, diff: 'Easy', note: 'All questions are compulsory.' },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer Type (40 words)', perQ: 2, count: 4, diff: 'Medium', note: 'Answer in not more than 40 words each.' },
                    { id: 'C', title: 'Section C', desc: 'Short Answer Type (60 words)', perQ: 3, count: 5, diff: 'Medium', note: 'Answer in not more than 60 words each.', hasOR: 2 },
                    { id: 'D', title: 'Section D', desc: 'Long Answer Type (120 words)', perQ: 5, count: 4, diff: 'Hard', note: 'Answer in not more than 120 words each.', hasOR: 2 },
                    { id: 'E', title: 'Section E', desc: 'Source/Case Based Questions', perQ: 4, count: 3, diff: 'Hard', note: 'Read the source and answer sub-questions.' }
                ],
                instructions: ['This question paper comprises 36 questions divided into 5 sections ‚Äî A, B, C, D and E.', 'Section A: 20 MCQs of 1 mark each.', 'Section B: 4 VSA questions of 2 marks each (40 words).', 'Section C: 5 SA questions of 3 marks each (60 words).', 'Section D: 4 LA questions of 5 marks each (120 words).', 'Section E: 3 case/source based questions of 4 marks each.', 'There is no overall choice. Internal choice is provided in some questions.']
            },
            'English': {
                code: '184', fullName: 'English Language and Literature', time: '3 Hours', maxMarks: 80,
                sections: [
                    { id: 'A', title: 'Section A ‚Äî Reading Skills', desc: 'Comprehension', perQ: 1, count: 20, diff: 'Easy', note: 'Read the passages and answer the questions. (20 marks)' },
                    { id: 'B', title: 'Section B ‚Äî Writing Skills & Grammar', desc: 'Writing and Grammar', perQ: 0, count: 0, diff: 'Medium', note: 'Answer all questions. (20 marks)', fixedMarks: 20 },
                    { id: 'C', title: 'Section C ‚Äî Literature', desc: 'Textbook Questions', perQ: 0, count: 0, diff: 'Hard', note: 'Based on prescribed textbooks. (40 marks)', fixedMarks: 40 }
                ],
                instructions: ['This question paper is divided into three sections ‚Äî A, B and C.', 'Section A: Reading Skills ‚Äî 20 marks', 'Section B: Writing Skills and Grammar ‚Äî 20 marks', 'Section C: Literature ‚Äî 40 marks', 'All questions are compulsory.', 'You may attempt any section at a time.']
            },
            'Hindi': {
                code: '002', fullName: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä ‡§Ö', time: '3 ‡§ò‡§£‡•ç‡§ü‡•á', maxMarks: 80, lang: 'hi',
                sections: [
                    { id: '‡§Ö', title: '‡§ñ‡§£‡•ç‡§° ‡§Ö ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§ ‡§¨‡•ã‡§ß', desc: '‡§Ö‡§™‡§†‡§ø‡§§ ‡§ó‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂/‡§™‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂', perQ: 1, count: 14, diff: 'Easy', note: '‡§Ö‡§™‡§†‡§ø‡§§ ‡§ó‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂ ‡§è‡§µ‡§Ç ‡§™‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂ ‡§™‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§¨‡§π‡•Å‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•§ (14 ‡§Ö‡§Ç‡§ï)' },
                    { id: '‡§¨', title: '‡§ñ‡§£‡•ç‡§° ‡§¨ ‚Äî ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§π‡§æ‡§∞‡§ø‡§ï ‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£', desc: '‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£', perQ: 1, count: 16, diff: 'Easy', note: '‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ ‡§™‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§¨‡§π‡•Å‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•§ (16 ‡§Ö‡§Ç‡§ï)' },
                    { id: '‡§∏', title: '‡§ñ‡§£‡•ç‡§° ‡§∏ ‚Äî ‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï', desc: '‡§ï‡•ç‡§∑‡§ø‡§§‡§ø‡§ú ‡§è‡§µ‡§Ç ‡§ï‡•É‡§§‡§ø‡§ï‡§æ', perQ: 0, count: 0, diff: 'Medium', note: '‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§∏‡•á ‡§∏‡§Æ‡•ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•§ (30 ‡§Ö‡§Ç‡§ï)', fixedMarks: 30 },
                    { id: '‡§¶', title: '‡§ñ‡§£‡•ç‡§° ‡§¶ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§≤‡•á‡§ñ‡§®', desc: '‡§≤‡•á‡§ñ‡§®', perQ: 0, count: 0, diff: 'Hard', note: '‡§Ö‡§®‡•Å‡§ö‡•ç‡§õ‡•á‡§¶, ‡§™‡§§‡•ç‡§∞, ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≤‡•á‡§ñ‡§®‡•§ (20 ‡§Ö‡§Ç‡§ï)', fixedMarks: 20 }
                ],
                instructions: ['‡§á‡§∏ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®-‡§™‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§ö‡§æ‡§∞ ‡§ñ‡§£‡•ç‡§° ‡§π‡•à‡§Ç ‚Äî ‡§Ö, ‡§¨, ‡§∏ ‡§î‡§∞ ‡§¶‡•§', '‡§ñ‡§£‡•ç‡§° ‡§Ö ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§ ‡§¨‡•ã‡§ß (14 ‡§Ö‡§Ç‡§ï)', '‡§ñ‡§£‡•ç‡§° ‡§¨ ‚Äî ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§π‡§æ‡§∞‡§ø‡§ï ‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ (16 ‡§Ö‡§Ç‡§ï)', '‡§ñ‡§£‡•ç‡§° ‡§∏ ‚Äî ‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§è‡§µ‡§Ç ‡§™‡•Ç‡§∞‡§ï ‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï (30 ‡§Ö‡§Ç‡§ï)', '‡§ñ‡§£‡•ç‡§° ‡§¶ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§≤‡•á‡§ñ‡§® (20 ‡§Ö‡§Ç‡§ï)', '‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡§Ç‡•§', '‡§Ø‡§•‡§æ‡§∏‡§Ç‡§≠‡§µ ‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§¶‡•Ä‡§ú‡§ø‡§è‡•§']
            },
            'Sanskrit': {
                code: '122', fullName: '‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç', time: '3 ‡§π‡•ã‡§∞‡§æ‡§É', maxMarks: 80, lang: 'sa',
                sections: [
                    { id: '‡§ï', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ï ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', desc: '‡§Ö‡§™‡§†‡§ø‡§§ ‡§Ö‡§µ‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', perQ: 1, count: 10, diff: 'Easy', note: '‡§Ö‡§™‡§†‡§ø‡§§ ‡§ó‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂‡§Æ‡•ç ‡§Ü‡§ß‡•É‡§§‡•ç‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§É‡•§ (10 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)' },
                    { id: '‡§ñ', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ñ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï‡§ï‡§æ‡§∞‡•ç‡§Ø‡§Æ‡•ç', desc: '‡§™‡§§‡•ç‡§∞‡§Æ‡•ç, ‡§Ö‡§®‡•Å‡§ö‡•ç‡§õ‡•á‡§¶‡§É', perQ: 0, count: 0, diff: 'Hard', note: '‡§™‡§§‡•ç‡§∞‡§≤‡•á‡§ñ‡§®‡§Æ‡•ç, ‡§Ö‡§®‡•Å‡§ö‡•ç‡§õ‡•á‡§¶‡§≤‡•á‡§ñ‡§®‡§Æ‡•ç ‡§ö‡•§ (15 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)', fixedMarks: 15 },
                    { id: '‡§ó', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ó ‚Äî ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•Å‡§ï‡•ç‡§§‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡§Æ‡•ç', desc: '‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡§Æ‡•ç', perQ: 1, count: 25, diff: 'Easy', note: '‡§∏‡§®‡•ç‡§ß‡§ø‡§É, ‡§â‡§™‡§∏‡§∞‡•ç‡§ó‡§æ‡§É, ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§Ø‡§æ‡§É, ‡§µ‡§ø‡§≠‡§ï‡•ç‡§§‡§ø‡§É‡•§ (25 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)' },
                    { id: '‡§ò', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ò ‚Äî ‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', desc: '‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡§Æ‡•ç', perQ: 0, count: 0, diff: 'Medium', note: '‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡§æ‡§§‡•ç ‡§∏‡§Æ‡•ç‡§¨‡§¶‡•ç‡§ß‡§æ‡§É ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§É‡•§ (30 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)', fixedMarks: 30 }
                ],
                instructions: ['‡§á‡§¶‡§Ç ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§™‡§§‡•ç‡§∞‡§Ç ‡§ö‡§§‡•Å‡§∞‡•ç‡§∑‡•Å ‡§ñ‡§£‡•ç‡§°‡•á‡§∑‡•Å ‡§µ‡§ø‡§≠‡§ï‡•ç‡§§‡§Æ‡•ç ‡§Ö‡§∏‡•ç‡§§‡§ø ‚Äî ‡§ï, ‡§ñ, ‡§ó, ‡§ò‡•§', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ï ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç (10 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ñ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï‡§ï‡§æ‡§∞‡•ç‡§Ø‡§Æ‡•ç (15 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ó ‚Äî ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•Å‡§ï‡•ç‡§§‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡§Æ‡•ç (25 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)', '‡§ñ‡§£‡•ç‡§°‡§É ‡§ò ‚Äî ‡§™‡§†‡§ø‡§§‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç (30 ‡§Ö‡§ô‡•ç‡§ï‡§æ‡§É)', '‡§∏‡§∞‡•ç‡§µ‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§É ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø‡§æ‡§É ‡§∏‡§®‡•ç‡§§‡§ø‡•§']
            },
            'Computer Science': {
                code: '402', fullName: 'Information Technology', time: '2 Hours 30 Minutes', maxMarks: 50,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'Objective Type Questions', perQ: 1, count: 15, diff: 'Easy', note: 'Employability Skills + IT Skills MCQs. (15 marks)' },
                    { id: 'B', title: 'Section B', desc: 'Short Answer Questions', perQ: 2, count: 5, diff: 'Medium', note: 'Answer in 30-50 words. (10 marks)', hasOR: 1 },
                    { id: 'C', title: 'Section C', desc: 'Long Answer Questions', perQ: 5, count: 5, diff: 'Hard', note: 'Answer in 80-120 words. (25 marks)', hasOR: 2 }
                ],
                instructions: ['This question paper contains 3 sections ‚Äî A, B and C.', 'Section A: 15 Objective Type Questions (15 marks).', 'Section B: 5 Short Answer Questions of 2 marks each (10 marks).', 'Section C: 5 Long Answer Questions of 5 marks each (25 marks).', 'All questions are compulsory. Internal choice is provided in some questions.']
            }
        };

        function selectSubject(btn) {
            document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedSubject = btn.dataset.subject;
            document.getElementById('create-btn').disabled = false;
        }
        function shuffle(arr) { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]] } return a }

        // ====== PARSE MCQ OPTIONS ======
        function parseMCQ(text) {
            const optRegex = /\(([A-Da-d])\)\s*([^\(]*?)(?=\([A-Da-d]\)|$)/g;
            const opts = []; let mainQ = text, m;
            const firstOpt = text.search(/\([A-Da-d]\)\s/);
            if (firstOpt > 0) {
                mainQ = text.substring(0, firstOpt).trim();
                const optPart = text.substring(firstOpt);
                while ((m = optRegex.exec(optPart)) !== null) opts.push({ label: m[1].toUpperCase(), text: m[2].trim() });
            }
            return opts.length >= 3 ? { question: mainQ, options: opts } : null;
        }

        // ====== PARSE SUB-PARTS ======
        function parseSubParts(text) {
            const subRegex = /\(([a-z]|[iv]+)\)\s*([^\(]*?)(?=\([a-z]\)|\([iv]+\)|$)/g;
            const parts = []; let mainQ = text;
            const firstSub = text.search(/\([a-z]\)\s/);
            if (firstSub > 0) {
                mainQ = text.substring(0, firstSub).trim();
                const subPart = text.substring(firstSub); let sm;
                while ((sm = subRegex.exec(subPart)) !== null) {
                    let pt = sm[2].trim(), pm = '';
                    const mM = pt.match(/\[(\d+)\]\s*$/);
                    if (mM) { pm = mM[1]; pt = pt.replace(/\[\d+\]\s*$/, '').trim() }
                    parts.push({ label: sm[1], text: pt, marks: pm });
                }
            }
            return parts.length >= 2 ? { question: mainQ, parts: parts } : null;
        }

        // ====== PARSE FIGURE ======
        function parseFigure(text) {
            const figMatch = text.match(/\[Figure:\s*([^\]]+)\]/i);
            if (figMatch) return { text: text.replace(figMatch[0], '').trim(), figure: figMatch[1] };
            return null;
        }

        // ====== RENDER QUESTION ======
        function renderQuestion(q, num, marks) {
            const text = q.question_text || '';
            let html = `<div class="question"><span class="q-num">${num}.</span><div class="q-body">`;
            // Check for figure
            const fig = parseFigure(text);
            const cleanText = fig ? fig.text : text;
            // Try MCQ
            const mcq = parseMCQ(cleanText);
            if (mcq) {
                html += `<div>${mcq.question}</div>`;
                if (fig) html += `<div class="figure-box">üìä ${fig.figure}</div>`;
                const longOpts = mcq.options.some(o => o.text.length > 40);
                html += `<div class="mcq-options${longOpts ? ' single-col' : ''}">`;
                mcq.options.forEach(o => { html += `<div class="mcq-opt">(${o.label}) ${o.text}</div>` });
                html += '</div>';
            } else {
                const sub = parseSubParts(cleanText);
                if (sub) {
                    html += `<div>${sub.question}</div>`;
                    if (fig) html += `<div class="figure-box">üìä ${fig.figure}</div>`;
                    html += '<div class="sub-parts">';
                    sub.parts.forEach(p => {
                        html += `<div class="sub-part"><span class="sub-part-label">(${p.label})</span><span class="sub-part-text">${p.text}</span>${p.marks ? `<span class="sub-part-marks">[${p.marks}]</span>` : ''}</div>`;
                    });
                    html += '</div>';
                } else {
                    html += `<div>${cleanText}</div>`;
                    if (fig) html += `<div class="figure-box">üìä ${fig.figure}</div>`;
                }
            }
            html += `</div><span class="q-marks">[${marks}]</span></div>`;
            return html;
        }

        // ====== CREATE PAPER ======
        async function createPaper() {
            const btn = document.getElementById('create-btn');
            const errDiv = document.getElementById('error-msg');
            errDiv.style.display = 'none';
            btn.classList.add('loading'); btn.disabled = true;
            try {
                const bp = BLUEPRINTS[selectedSubject];
                if (!bp) throw new Error('Unknown subject');
                let { data: allQ, error } = await db.from('question_bank').select('*').eq('subject', selectedSubject).limit(2000);
                if (error) throw error;
                if (!allQ || allQ.length === 0) throw new Error(`No questions found for ${selectedSubject}.`);

                // Split by difficulty
                const easyQ = shuffle(allQ.filter(q => (q.difficulty || '').toLowerCase() === 'easy'));
                const medQ = shuffle(allQ.filter(q => (q.difficulty || '').toLowerCase() === 'medium'));
                const hardQ = shuffle(allQ.filter(q => (q.difficulty || '').toLowerCase() === 'hard'));
                const usedIds = new Set();
                let globalQ = 0;

                function pick(pool, n) {
                    const res = [];
                    for (let i = 0; i < n; i++) {
                        const idx = pool.findIndex(q => !usedIds.has(q.id));
                        if (idx !== -1) { usedIds.add(pool[idx].id); res.push(pool.splice(idx, 1)[0]) }
                    }
                    return res;
                }
                function pickAny(n) {
                    let res = pick(easyQ, n);
                    if (res.length < n) res = res.concat(pick(medQ, n - res.length));
                    if (res.length < n) res = res.concat(pick(hardQ, n - res.length));
                    return res;
                }

                const paperEl = document.getElementById('paper-content');
                const isHindi = bp.lang === 'hi'; const isSanskrit = bp.lang === 'sa';
                paperEl.className = `paper${isHindi ? ' hindi-paper' : ''}${isSanskrit ? ' sanskrit-paper' : ''}`;
                let html = '';

                // HEADER
                html += `<div class="paper-header">`;
                html += `<div class="board-name">Central Board of Secondary Education</div>`;
                html += `<div class="school-name">ANNUAL EXAMINATION (2024-25)</div>`;
                html += `<div class="exam-title">${bp.fullName}</div>`;
                html += `<div class="exam-session">Class ‚Äì IX | Subject Code: ${bp.code}</div>`;
                html += `</div>`;
                html += `<div class="paper-meta-row bordered">`;
                html += `<span>${isHindi || isSanskrit ? '‡§∏‡§Æ‡§Ø :' : 'Time Allowed:'} ${bp.time}</span>`;
                html += `<span>${isHindi || isSanskrit ? '‡§™‡•Ç‡§∞‡•ç‡§£‡§æ‡§Ç‡§ï :' : 'Maximum Marks:'} ${bp.maxMarks}</span>`;
                html += `</div>`;

                // INSTRUCTIONS
                html += `<div class="paper-instructions">`;
                html += `<h4>${isHindi ? '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂' : isSanskrit ? '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§æ‡§É' : 'General Instructions'}</h4><ol>`;
                bp.instructions.forEach(i => { html += `<li>${i}</li>` });
                html += '</ol></div>';

                // SECTIONS
                bp.sections.forEach(sec => {
                    html += `<div class="section-header">${sec.title} ‚Äî ${sec.desc}<span class="section-info">${sec.note}</span></div>`;

                    if (sec.count > 0) {
                        // Pick from the right difficulty pool
                        let pool = sec.diff === 'Easy' ? easyQ : sec.diff === 'Medium' ? medQ : hardQ;
                        let qs = pick(pool, sec.count);
                        // If not enough, pick from any
                        if (qs.length < sec.count) qs = qs.concat(pickAny(sec.count - qs.length));

                        qs.forEach((q, i) => {
                            globalQ++;
                            html += renderQuestion(q, globalQ, sec.perQ);
                            // Internal choice OR
                            if (sec.hasOR && i >= sec.count - sec.hasOR) {
                                const alt = pick(pool, 1)[0] || pickAny(1)[0];
                                if (alt) { html += `<div class="or-divider">OR</div>`; html += renderQuestion(alt, globalQ, sec.perQ) }
                            }
                        });
                    } else if (sec.fixedMarks) {
                        let pool = sec.diff === 'Easy' ? easyQ : sec.diff === 'Medium' ? medQ : hardQ;
                        let remaining = sec.fixedMarks;
                        let marksSeq = [];
                        // Create a sensible marks sequence
                        if (remaining >= 40) { marksSeq = [5, 5, 5, 5, 4, 4, 4, 4, 2, 2] }
                        else if (remaining >= 30) { marksSeq = [5, 5, 5, 3, 3, 3, 3, 2, 1] }
                        else if (remaining >= 20) { marksSeq = [5, 5, 3, 3, 2, 2] }
                        else if (remaining >= 15) { marksSeq = [5, 5, 3, 2] }
                        else { marksSeq = [3, 3, 2, 2, 2, 2] }

                        marksSeq.forEach(m => {
                            const q = pick(pool, 1)[0] || pickAny(1)[0];
                            if (q) { globalQ++; html += renderQuestion(q, globalQ, m) }
                        });
                    }
                });

                html += `<div class="paper-footer">‚ú¶ ‚ú¶ ‚ú¶ End of Question Paper ‚ú¶ ‚ú¶ ‚ú¶<br><span style="font-style:italic">study.dhruvshah.co ‚Äî CBSE Question Bank</span></div>`;
                paperEl.innerHTML = html;
                document.getElementById('selection-view').style.display = 'none';
                document.getElementById('paper-view').style.display = 'block';
                window.scrollTo(0, 0);
            } catch (err) {
                errDiv.textContent = err.message; errDiv.style.display = 'block';
            } finally {
                btn.classList.remove('loading'); btn.disabled = !selectedSubject;
            }
        }
        function goBack() {
            document.getElementById('paper-view').style.display = 'none';
            document.getElementById('selection-view').style.display = 'block';
        }
    </script>
</body>

</html>