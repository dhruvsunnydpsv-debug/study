<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBSE Paper Creator | Study Vault</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Serif:ital,wght@0,400;0,700;1,400&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #06060b;
            --surface: rgba(255, 255, 255, 0.03);
            --surface-hover: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.08);
            --text: #eeeef2;
            --text-dim: rgba(238, 238, 242, 0.55);
            --accent: #7c3aed
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden
        }

        .aurora {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none
        }

        .aurora div {
            position: absolute;
            border-radius: 50%;
            filter: blur(130px);
            opacity: 0.1;
            animation: drift 22s ease-in-out infinite
        }

        .aurora div:nth-child(1) {
            width: 550px;
            height: 550px;
            background: #7c3aed;
            top: -8%;
            left: -3%
        }

        .aurora div:nth-child(2) {
            width: 450px;
            height: 450px;
            background: #06b6d4;
            top: 35%;
            right: -8%;
            animation-delay: -8s
        }

        @keyframes drift {

            0%,
            100% {
                transform: translate(0, 0) scale(1)
            }

            33% {
                transform: translate(25px, -35px) scale(1.04)
            }

            66% {
                transform: translate(-20px, 25px) scale(0.96)
            }
        }

        .app {
            position: relative;
            z-index: 1;
            max-width: 960px;
            margin: 0 auto;
            padding: 48px 24px 80px
        }

        .hero-title {
            font-size: clamp(2rem, 5vw, 3.4rem);
            font-weight: 800;
            background: linear-gradient(135deg, #f0f0f5 10%, #a78bfa 55%, #06b6d4 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.15;
            margin-bottom: 10px;
            text-align: center
        }

        .hero-sub {
            color: var(--text-dim);
            text-align: center;
            max-width: 520px;
            margin: 0 auto 44px;
            font-size: 1rem
        }

        .form-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 36px 32px;
            max-width: 620px;
            margin: 0 auto
        }

        .form-label {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 15px;
            display: block
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 28px
        }

        .subject-btn {
            padding: 15px 5px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px
        }

        .subject-btn:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: var(--surface-hover)
        }

        .subject-btn.active {
            background: rgba(124, 58, 237, 0.15);
            border-color: var(--accent);
            color: white
        }

        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 24px
        }

        .diff-btn {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.7rem
        }

        .diff-btn.active {
            background: rgba(6, 182, 212, 0.1);
            border-color: #06b6d4;
            color: #67e8f9
        }

        .create-btn {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: none;
            background: var(--accent);
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.95rem;
            transition: 0.2s
        }

        .create-btn:hover:not(:disabled) {
            background: #6d28d9;
            transform: translateY(-1px)
        }

        .create-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed
        }

        #paper-view {
            display: none
        }

        .paper-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 24px;
            flex-wrap: wrap
        }

        .action-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s
        }

        .action-btn:hover {
            background: var(--surface-hover);
            color: white
        }

        .stats-bar {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 16px;
            font-size: 0.75rem;
            color: var(--text-dim)
        }

        .stats-bar span {
            background: var(--surface);
            padding: 4px 12px;
            border-radius: 6px;
            border: 1px solid var(--border)
        }

        /* Paper Styles - Exact CBSE Format */
        .paper {
            background: white;
            color: #111;
            padding: 40px 50px;
            border-radius: 5px;
            font-family: 'Noto Serif', serif;
            line-height: 1.7;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            font-size: 0.9rem
        }

        .paper.hi,
        .paper.sa {
            font-family: 'Noto Sans Devanagari', serif
        }

        .paper-header {
            text-align: center;
            border-bottom: 2px solid #111;
            padding-bottom: 12px;
            margin-bottom: 0
        }

        .paper-header .school-line {
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            color: #555;
            text-transform: uppercase
        }

        .paper-header .exam-line {
            font-weight: 700;
            font-size: 1.15rem;
            margin: 4px 0
        }

        .paper-header .subject-line {
            font-size: 0.95rem;
            font-weight: 600
        }

        .paper-header .code-line {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px
        }

        .paper-meta {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #ccc;
            padding: 8px 0;
            font-size: 0.85rem;
            font-weight: 500
        }

        .paper-instructions {
            border: 1px solid #333;
            padding: 12px 16px;
            margin: 14px 0 20px;
            font-size: 0.78rem;
            background: #fafafa;
            line-height: 1.8
        }

        .paper-instructions strong {
            display: block;
            margin-bottom: 6px;
            font-size: 0.82rem
        }

        .paper-instructions ol {
            padding-left: 18px
        }

        .paper-instructions li {
            margin-bottom: 3px
        }

        .section-header {
            font-weight: 700;
            background: #f0f0f0;
            padding: 8px 14px;
            margin: 24px 0 14px;
            border-left: 4px solid #222;
            font-size: 0.88rem;
            letter-spacing: 0.02em
        }

        .section-header .q-range {
            float: right;
            font-weight: 400;
            color: #666;
            font-size: 0.78rem
        }

        .question {
            display: flex;
            margin-bottom: 16px;
            page-break-inside: avoid
        }

        .q-num {
            font-weight: 700;
            width: 32px;
            flex-shrink: 0;
            font-size: 0.88rem
        }

        .q-body {
            flex: 1
        }

        .q-marks {
            font-weight: 700;
            font-size: 0.78rem;
            margin-left: 10px;
            white-space: nowrap;
            color: #333
        }

        .mcq-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px 20px;
            margin-top: 6px;
            padding-left: 8px
        }

        .mcq-options.single-col {
            grid-template-columns: 1fr
        }

        .mcq-opt {
            font-size: 0.85rem;
            padding: 2px 0
        }

        .figure-box {
            margin: 8px 0;
            text-align: center;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 4px;
            background: #fff
        }

        .q-image {
            max-width: 100%;
            max-height: 220px;
            border: 1px solid #ddd;
            border-radius: 3px
        }

        .sub-parts {
            margin-top: 6px;
            padding-left: 16px
        }

        .sub-part {
            display: flex;
            gap: 6px;
            margin-bottom: 4px;
            font-size: 0.85rem
        }

        .or-divider {
            text-align: center;
            font-style: italic;
            font-weight: 700;
            margin: 12px 0;
            color: #555;
            font-size: 0.9rem;
            letter-spacing: 0.05em
        }

        .or-divider::before,
        .or-divider::after {
            content: '';
            display: inline-block;
            width: 60px;
            height: 1px;
            background: #aaa;
            vertical-align: middle;
            margin: 0 10px
        }

        .assertion-block {
            margin-top: 4px;
            padding-left: 4px;
            font-size: 0.85rem;
            line-height: 1.7
        }

        .assertion-block .ar-label {
            font-weight: 600
        }

        .case-study-intro {
            font-style: italic;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #f8f8f8;
            border-left: 3px solid #7c3aed;
            border-radius: 0 4px 4px 0;
            font-size: 0.84rem;
            line-height: 1.7
        }

        .fixed-section-note {
            text-align: center;
            padding: 16px;
            font-style: italic;
            color: #666;
            font-size: 0.82rem;
            border: 1px dashed #ccc;
            border-radius: 6px;
            margin: 8px 0
        }

        .answer-key {
            margin-top: 24px;
            border-top: 2px solid #111;
            padding-top: 14px
        }

        .answer-key h3 {
            font-size: 0.9rem;
            margin-bottom: 10px
        }

        .answer-key .ak-item {
            display: inline-block;
            width: 120px;
            font-size: 0.78rem;
            margin-bottom: 4px
        }

        /* Print */
        @media print {

            .aurora,
            .paper-actions,
            .hero-title,
            .hero-sub,
            .form-card,
            .stats-bar,
            #selection-view {
                display: none !important
            }

            body {
                background: white
            }

            .paper {
                box-shadow: none;
                padding: 20px 30px;
                max-width: 100%
            }

            .question {
                page-break-inside: avoid
            }

            .section-header {
                page-break-after: avoid
            }

            .answer-key {
                page-break-before: always
            }
        }

        /* Mobile */
        @media(max-width:768px) {
            .app {
                padding: 24px 12px 60px
            }

            .hero-title {
                font-size: 1.6rem
            }

            .hero-sub {
                font-size: 0.85rem;
                margin-bottom: 24px
            }

            .form-card {
                padding: 20px 16px
            }

            .subject-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px
            }

            .difficulty-selector {
                grid-template-columns: repeat(2, 1fr)
            }

            .paper {
                padding: 20px 16px;
                font-size: 0.82rem
            }

            .mcq-options {
                grid-template-columns: 1fr
            }

            .question {
                flex-wrap: wrap
            }

            .q-image {
                max-height: 160px
            }
        }

        @media(max-width:400px) {
            .subject-grid {
                grid-template-columns: 1fr 1fr
            }

            .paper {
                padding: 12px 10px;
                font-size: 0.78rem
            }
        }
    </style>
</head>

<body>
    <div class="aurora">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div class="app">
        <div id="selection-view">
            <h1 class="hero-title">CBSE Paper Creator</h1>
            <p class="hero-sub">Exact 2025-26 Pattern ‚Ä¢ Official Blueprint Compliant ‚Ä¢ Diagrams & Internal Choice</p>
            <div class="form-card">
                <label class="form-label">1. Select Subject</label>
                <div class="subject-grid">
                    <button class="subject-btn" onclick="setSubject(this,'Maths')">œÄ Maths</button>
                    <button class="subject-btn" onclick="setSubject(this,'Science')">‚öõ Science</button>
                    <button class="subject-btn" onclick="setSubject(this,'Social Science')">üåç SST</button>
                    <button class="subject-btn" onclick="setSubject(this,'English')">Aa English</button>
                    <button class="subject-btn" onclick="setSubject(this,'Hindi')">‡§Ö ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
                    <button class="subject-btn" onclick="setSubject(this,'Sanskrit')">üïâ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç</button>
                </div>
                <label class="form-label">2. Difficulty Level</label>
                <div class="difficulty-selector">
                    <button class="diff-btn active" onclick="setDiff(this,'Mixed')">Mixed</button>
                    <button class="diff-btn" onclick="setDiff(this,'Easy')">Easy</button>
                    <button class="diff-btn" onclick="setDiff(this,'Medium')">Medium</button>
                    <button class="diff-btn" onclick="setDiff(this,'Hard')">Hard</button>
                </div>
                <button class="create-btn" id="create-btn" onclick="createPaper()" disabled>Generate Question
                    Paper</button>
                <div id="error-msg" style="color:#f87171;margin-top:10px;font-size:0.8rem;display:none"></div>
            </div>
        </div>
        <div id="paper-view">
            <div class="paper-actions">
                <button class="action-btn" onclick="location.reload()">‚Üê New Paper</button>
                <button class="action-btn" onclick="toggleAnswers()" id="ans-btn">Show Answer Key</button>
                <button class="action-btn" onclick="window.print()"
                    style="background:var(--accent);color:white;border:none">üñ® Print / PDF</button>
            </div>
            <div class="stats-bar" id="stats-bar"></div>
            <div id="paper-content"></div>
        </div>
    </div>

    <script>
        const db = window.supabase.createClient("https://wfegooasrtbhpursgcvh.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmZWdvb2FzcnRiaHB1cnNnY3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzOTA2NzAsImV4cCI6MjA4Njk2NjY3MH0.vV3vHZR2wqDI8WJ1zgcgJtY0J_eL21SbuE6WqciRN7s");
        let selectedGrade = 9, selectedSubject = null, selectedDiff = 'Mixed', paperCount = 0, currentAnswers = [];

        // ============ EXACT CBSE 2025-26 BLUEPRINTS ============
        const BLUEPRINTS = {
            'Maths': {
                code: '041', fullName: 'Mathematics (Standard)', time: '3 Hours', maxMarks: 80,
                totalQ: 38,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'Multiple Choice Questions', perQ: 1, count: 20, qType: 'mcq', hasAR: true, arStart: 19 },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer (SA-I)', perQ: 2, count: 5, internalChoice: true },
                    { id: 'C', title: 'Section C', desc: 'Short Answer (SA-II)', perQ: 3, count: 6, internalChoice: true },
                    { id: 'D', title: 'Section D', desc: 'Long Answer', perQ: 5, count: 4, internalChoice: true },
                    { id: 'E', title: 'Section E', desc: 'Case Study Based', perQ: 4, count: 3, qType: 'case', caseSubParts: [1, 1, 2] }
                ],
                inst: [
                    'This question paper contains 38 questions. All questions are compulsory.',
                    'This question paper is divided into FIVE Sections ‚Äî A, B, C, D and E.',
                    'In Section A, Questions no. 1 to 18 are Multiple Choice Questions (MCQs) and Questions no. 19 & 20 are Assertion-Reason based questions of 1 mark each.',
                    'In Section B, Questions no. 21 to 25 are Very Short Answer (SA-I) type questions, carrying 2 marks each.',
                    'In Section C, Questions no. 26 to 31 are Short Answer (SA-II) type questions, carrying 3 marks each.',
                    'In Section D, Questions no. 32 to 35 are Long Answer (LA) type questions, carrying 5 marks each.',
                    'In Section E, Questions no. 36 to 38 are Case Study Based questions, carrying 4 marks each.',
                    'There is no overall choice. However, an internal choice has been provided in 2 questions in Section B, 2 questions in Section C, 2 questions in Section D, and 3 questions in Section E.',
                    'Draw neat figures wherever required. Take œÄ = 22/7 wherever required, if not stated.',
                    'Use of calculators is NOT allowed.'
                ]
            },
            'Science': {
                code: '086', fullName: 'Science', time: '3 Hours', maxMarks: 80,
                totalQ: 39,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'Multiple Choice Questions', perQ: 1, count: 20, qType: 'mcq', hasAR: true, arStart: 19 },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer', perQ: 2, count: 6, internalChoice: true },
                    { id: 'C', title: 'Section C', desc: 'Short Answer', perQ: 3, count: 7, internalChoice: true },
                    { id: 'D', title: 'Section D', desc: 'Long Answer', perQ: 5, count: 3, internalChoice: true },
                    { id: 'E', title: 'Section E', desc: 'Case Study Based', perQ: 4, count: 3, qType: 'case', caseSubParts: [1, 1, 2] }
                ],
                inst: [
                    'This question paper contains 39 questions. All questions are compulsory.',
                    'This question paper is divided into FIVE Sections ‚Äî A, B, C, D and E.',
                    'In Section A, Questions no. 1 to 18 are MCQs and Questions no. 19 & 20 are Assertion-Reason based questions of 1 mark each.',
                    'In Section B, Questions no. 21 to 26 are Very Short Answer type questions, carrying 2 marks each. Answer in 30‚Äì50 words.',
                    'In Section C, Questions no. 27 to 33 are Short Answer type questions, carrying 3 marks each. Answer in 50‚Äì80 words.',
                    'In Section D, Questions no. 34 to 36 are Long Answer type questions, carrying 5 marks each. Answer in 80‚Äì120 words.',
                    'In Section E, Questions no. 37 to 39 are Case Study Based questions, carrying 4 marks each.',
                    'There is no overall choice. However, an internal choice has been provided in some questions.',
                    'Draw neat and labelled diagrams wherever necessary.',
                    'Use of calculators is NOT allowed.'
                ]
            },
            'Social Science': {
                code: '087', fullName: 'Social Science', time: '3 Hours', maxMarks: 80,
                totalQ: 37,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'Multiple Choice Questions', perQ: 1, count: 20, qType: 'mcq' },
                    { id: 'B', title: 'Section B', desc: 'Very Short Answer (40 words)', perQ: 2, count: 4, internalChoice: true },
                    { id: 'C', title: 'Section C', desc: 'Short Answer (60 words)', perQ: 3, count: 5, internalChoice: true },
                    { id: 'D', title: 'Section D', desc: 'Long Answer (120 words)', perQ: 5, count: 4, internalChoice: true },
                    { id: 'E', title: 'Section E', desc: 'Case Study Based', perQ: 4, count: 3, qType: 'case', caseSubParts: [1, 1, 2] },
                    { id: 'F', title: 'Section F', desc: 'Map Based (History 2m + Geography 3m)', perQ: 5, count: 1, qType: 'map' }
                ],
                inst: [
                    'This question paper contains 37 questions. All questions are compulsory.',
                    'This paper is divided into SIX Sections ‚Äî A, B, C, D, E and F.',
                    'Section A has 20 MCQs carrying 1 mark each.',
                    'Section B has 4 questions carrying 2 marks each. Answer in about 40 words.',
                    'Section C has 5 questions carrying 3 marks each. Answer in about 60 words.',
                    'Section D has 4 questions carrying 5 marks each. Answer in about 120 words.',
                    'Section E has 3 Case Based questions carrying 4 marks each.',
                    'Section F has 1 Map Based question of 5 marks ‚Äî History (2m) + Geography (3m).',
                    'There is no overall choice. However, internal choice has been provided in some questions.',
                    'Map of India must be attached with the answer script.'
                ]
            },
            'English': {
                code: '184', fullName: 'English Language & Literature', time: '3 Hours', maxMarks: 80,
                totalQ: 11,
                sections: [
                    { id: 'A', title: 'Section A', desc: 'Reading Skills', perQ: 1, count: 20, qType: 'mcq' },
                    {
                        id: 'B', title: 'Section B', desc: 'Writing Skills & Grammar', perQ: 0, count: 0, fixed: 20, fixedSections: [
                            { label: 'Grammar (Gap filling, Editing, Transformation)', marks: 10, count: 10, perQ: 1, qType: 'mcq' },
                            { label: 'Writing Skills ‚Äî Descriptive Paragraph / Story / Diary Entry', marks: 10, fixedNote: 'Attempt questions as directed. Internal choice provided.' }
                        ]
                    },
                    {
                        id: 'C', title: 'Section C', desc: 'Language Through Literature', perQ: 0, count: 0, fixed: 40, fixedSections: [
                            { label: 'Reference to Context (Prose/Poetry extracts)', marks: 10 },
                            { label: 'Short Answer Questions from Beehive (40-50 words)', marks: 12, count: 4, perQ: 3 },
                            { label: 'Long Answer from Beehive (100-120 words)', marks: 6, count: 1, perQ: 6, internalChoice: true },
                            { label: 'Short Answer Questions from Moments (40-50 words)', marks: 6, count: 2, perQ: 3 },
                            { label: 'Long Answer from Moments (100-120 words)', marks: 6, count: 1, perQ: 6, internalChoice: true }
                        ]
                    }
                ],
                inst: [
                    'This question paper is divided into THREE Sections ‚Äî A, B and C.',
                    'Section A ‚Äî Reading Skills ‚Äî 20 Marks.',
                    'Section B ‚Äî Writing Skills & Grammar ‚Äî 20 Marks.',
                    'Section C ‚Äî Language Through Literature ‚Äî 40 Marks.',
                    'All questions are compulsory.',
                    'Attempt questions based on specific instructions for each part.'
                ]
            },
            'Hindi': {
                code: '002', fullName: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä ‡§ï‡•ã‡§∞‡•ç‡§∏ \'‡§Ö\'', time: '3 Hours', maxMarks: 80, lang: 'hi',
                totalQ: 17,
                sections: [
                    { id: '‡§Ö', title: '‡§ñ‡§£‡•ç‡§° ‡§Ö ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§ ‡§¨‡•ã‡§ß', desc: 'Unseen Comprehension (‡§ó‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂ + ‡§ï‡§æ‡§µ‡•ç‡§Ø‡§æ‡§Ç‡§∂)', perQ: 1, count: 14, qType: 'mcq' },
                    { id: '‡§¨', title: '‡§ñ‡§£‡•ç‡§° ‡§¨ ‚Äî ‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£', desc: 'Grammar (‡§â‡§™‡§∏‡§∞‡•ç‡§ó, ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§Ø, ‡§∏‡§Æ‡§æ‡§∏, ‡§µ‡§æ‡§ï‡•ç‡§Ø ‡§≠‡•á‡§¶, ‡§Ö‡§≤‡§Ç‡§ï‡§æ‡§∞)', perQ: 1, count: 16, qType: 'mcq' },
                    {
                        id: '‡§∏', title: '‡§ñ‡§£‡•ç‡§° ‡§∏ ‚Äî ‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§è‡§µ‡§Ç ‡§™‡•Ç‡§∞‡§ï ‡§™‡•Å‡§∏‡•ç‡§§‡§ï', desc: 'Literature (‡§ï‡•ç‡§∑‡§ø‡§§‡§ø‡§ú + ‡§ï‡•É‡§§‡§ø‡§ï‡§æ)', perQ: 0, count: 0, fixed: 30, fixedSections: [
                            { label: '‡§™‡§æ‡§†‡§ø‡§§ ‡§ó‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂ (MCQ)', marks: 5, count: 5, perQ: 1, qType: 'mcq' },
                            { label: '‡§™‡§æ‡§†‡§ø‡§§ ‡§ï‡§æ‡§µ‡•ç‡§Ø‡§æ‡§Ç‡§∂ (MCQ)', marks: 5, count: 5, perQ: 1, qType: 'mcq' },
                            { label: '‡§ó‡§¶‡•ç‡§Ø ‡§ñ‡§£‡•ç‡§° ‚Äî ‡§≤‡§ò‡•Å/‡§¶‡•Ä‡§∞‡•ç‡§ò ‡§â‡§§‡•ç‡§§‡§∞‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®', marks: 8, count: 3, perQ: 0 },
                            { label: '‡§ï‡§æ‡§µ‡•ç‡§Ø ‡§ñ‡§£‡•ç‡§° ‚Äî ‡§≤‡§ò‡•Å/‡§¶‡•Ä‡§∞‡•ç‡§ò ‡§â‡§§‡•ç‡§§‡§∞‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®', marks: 6, count: 2, perQ: 3 },
                            { label: '‡§™‡•Ç‡§∞‡§ï ‡§™‡•Å‡§∏‡•ç‡§§‡§ï (‡§ï‡•É‡§§‡§ø‡§ï‡§æ)', marks: 6, count: 2, perQ: 3 }
                        ]
                    },
                    {
                        id: '‡§¶', title: '‡§ñ‡§£‡•ç‡§° ‡§¶ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§≤‡•á‡§ñ‡§®', desc: 'Creative Writing (‡§Ö‡§®‡•Å‡§ö‡•ç‡§õ‡•á‡§¶, ‡§™‡§§‡•ç‡§∞, ‡§à‡§Æ‡•á‡§≤/‡§ï‡§π‡§æ‡§®‡•Ä)', perQ: 0, count: 0, fixed: 20, fixedSections: [
                            { label: '‡§Ö‡§®‡•Å‡§ö‡•ç‡§õ‡•á‡§¶ ‡§≤‡•á‡§ñ‡§® (120 ‡§∂‡§¨‡•ç‡§¶)', marks: 6, count: 1, perQ: 6 },
                            { label: '‡§î‡§™‡§ö‡§æ‡§∞‡§ø‡§ï/‡§Ö‡§®‡•å‡§™‡§ö‡§æ‡§∞‡§ø‡§ï ‡§™‡§§‡•ç‡§∞', marks: 5, count: 1, perQ: 5 },
                            { label: '‡§∏‡§Ç‡§µ‡§æ‡§¶ ‡§≤‡•á‡§ñ‡§® / ‡§à‡§Æ‡•á‡§≤ / ‡§ï‡§π‡§æ‡§®‡•Ä', marks: 5, count: 1, perQ: 5 },
                            { label: '‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® / ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§≤‡•á‡§ñ‡§®', marks: 4, count: 1, perQ: 4 }
                        ]
                    }
                ],
                inst: [
                    '‡§á‡§∏ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®-‡§™‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§≤ ‡§ö‡§æ‡§∞ ‡§ñ‡§£‡•ç‡§° ‡§π‡•à‡§Ç ‚Äî ‡§Ö, ‡§¨, ‡§∏, ‡§¶‡•§',
                    '‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡§Ç‡•§',
                    '‡§ñ‡§£‡•ç‡§° ‡§Ö ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§ ‡§¨‡•ã‡§ß ‚Äî 14 ‡§Ö‡§Ç‡§ï‡•§',
                    '‡§ñ‡§£‡•ç‡§° ‡§¨ ‚Äî ‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ ‚Äî 16 ‡§Ö‡§Ç‡§ï‡•§',
                    '‡§ñ‡§£‡•ç‡§° ‡§∏ ‚Äî ‡§™‡§æ‡§†‡•ç‡§Ø‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§è‡§µ‡§Ç ‡§™‡•Ç‡§∞‡§ï ‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‚Äî 30 ‡§Ö‡§Ç‡§ï‡•§',
                    '‡§ñ‡§£‡•ç‡§° ‡§¶ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§≤‡•á‡§ñ‡§® ‚Äî 20 ‡§Ö‡§Ç‡§ï‡•§',
                    '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•ç‡§¶‡§∞ ‡§è‡§µ‡§Ç ‡§∏‡•ç‡§µ‡§ö‡•ç‡§õ ‡§≤‡§ø‡§ñ‡§æ‡§µ‡§ü ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§'
                ]
            },
            'Sanskrit': {
                code: '122', fullName: '‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç', time: '3 Hours', maxMarks: 80, lang: 'sa',
                totalQ: 46,
                sections: [
                    { id: '‡§ï', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ï ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§-‡§Ö‡§µ‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', desc: 'Unseen Comprehension', perQ: 1, count: 10, qType: 'mcq' },
                    {
                        id: '‡§ñ', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ñ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï-‡§ï‡§æ‡§∞‡•ç‡§Ø‡§Æ‡•ç', desc: 'Creative Writing (‡§™‡§§‡•ç‡§∞, ‡§ö‡§ø‡§§‡•ç‡§∞‡§µ‡§∞‡•ç‡§£‡§®, ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶)', perQ: 0, count: 0, fixed: 15, fixedSections: [
                            { label: '‡§™‡§§‡•ç‡§∞-‡§≤‡•á‡§ñ‡§®‡§Æ‡•ç', marks: 5, count: 1, perQ: 5 },
                            { label: '‡§ö‡§ø‡§§‡•ç‡§∞-‡§µ‡§∞‡•ç‡§£‡§®‡§Æ‡•ç ‡§Ö‡§•‡§µ‡§æ ‡§Ö‡§®‡•Å‡§ö‡•ç‡§õ‡•á‡§¶-‡§≤‡•á‡§ñ‡§®‡§Æ‡•ç', marks: 5, count: 1, perQ: 5, internalChoice: true },
                            { label: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä-‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§-‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶‡§É', marks: 5, count: 1, perQ: 5 }
                        ]
                    },
                    { id: '‡§ó', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ó ‚Äî ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•Å‡§ï‡•ç‡§§-‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡§Æ‡•ç', desc: 'Applied Grammar (‡§∏‡§®‡•ç‡§ß‡§ø, ‡§∂‡§¨‡•ç‡§¶‡§∞‡•Ç‡§™, ‡§ß‡§æ‡§§‡•Å‡§∞‡•Ç‡§™, ‡§ï‡§æ‡§∞‡§ï)', perQ: 1, count: 25, qType: 'mcq' },
                    {
                        id: '‡§ò', title: '‡§ñ‡§£‡•ç‡§°‡§É ‡§ò ‚Äî ‡§™‡§†‡§ø‡§§-‡§Ö‡§µ‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç', desc: 'Literature Comprehension (‡§∂‡•á‡§Æ‡•Å‡§∑‡•Ä)', perQ: 0, count: 0, fixed: 30, fixedSections: [
                            { label: '‡§™‡§†‡§ø‡§§-‡§ó‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂‡§Æ‡•ç ‚Äî MCQ', marks: 6, count: 6, perQ: 1, qType: 'mcq' },
                            { label: '‡§™‡§†‡§ø‡§§-‡§™‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂‡§Æ‡•ç ‚Äî MCQ', marks: 4, count: 4, perQ: 1, qType: 'mcq' },
                            { label: '‡§≤‡§ò‡•Å-‡§â‡§§‡•ç‡§§‡§∞‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§É (‡§∂‡•á‡§Æ‡•Å‡§∑‡•Ä)', marks: 10, count: 5, perQ: 2 },
                            { label: '‡§¶‡•Ä‡§∞‡•ç‡§ò-‡§â‡§§‡•ç‡§§‡§∞‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§É', marks: 10, count: 2, perQ: 5, internalChoice: true }
                        ]
                    }
                ],
                inst: [
                    '‡§Ö‡§∏‡•ç‡§Æ‡§ø‡§®‡•ç ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§™‡§§‡•ç‡§∞‡•á ‡§ö‡§§‡•ç‡§µ‡§æ‡§∞‡§É ‡§ñ‡§£‡•ç‡§°‡§æ‡§É ‡§∏‡§®‡•ç‡§§‡§ø ‚Äî ‡§ï, ‡§ñ, ‡§ó, ‡§ò‡•§',
                    '‡§∏‡§∞‡•ç‡§µ‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§É ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø‡§æ‡§É‡•§',
                    '‡§ñ‡§£‡•ç‡§°‡§É ‡§ï ‚Äî ‡§Ö‡§™‡§†‡§ø‡§§-‡§Ö‡§µ‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç ‚Äî 10 ‡§Ö‡§Ç‡§ï‡§æ‡§É‡•§',
                    '‡§ñ‡§£‡•ç‡§°‡§É ‡§ñ ‚Äî ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï-‡§ï‡§æ‡§∞‡•ç‡§Ø‡§Æ‡•ç ‚Äî 15 ‡§Ö‡§Ç‡§ï‡§æ‡§É‡•§',
                    '‡§ñ‡§£‡•ç‡§°‡§É ‡§ó ‚Äî ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•Å‡§ï‡•ç‡§§-‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£‡§Æ‡•ç ‚Äî 25 ‡§Ö‡§Ç‡§ï‡§æ‡§É‡•§',
                    '‡§ñ‡§£‡•ç‡§°‡§É ‡§ò ‚Äî ‡§™‡§†‡§ø‡§§-‡§Ö‡§µ‡§¨‡•ã‡§ß‡§®‡§Æ‡•ç ‚Äî 30 ‡§Ö‡§Ç‡§ï‡§æ‡§É‡•§',
                    '‡§∏‡•ç‡§µ‡§ö‡•ç‡§õ‡§æ‡§ï‡•ç‡§∑‡§∞‡•à‡§É ‡§â‡§§‡•ç‡§§‡§∞‡§Ç ‡§≤‡§ø‡§ñ‡§§‡•§'
                ]
            }
        };

        function setSubject(btn, s) { document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); selectedSubject = s; document.getElementById('create-btn').disabled = false }
        function setDiff(btn, d) { document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); selectedDiff = d }

        function parseFig(text) {
            const imgM = text.match(/\[Image:\s*([^\]]+)\]/i);
            const figM = text.match(/\[Figure:\s*([^\]]+)\]/i);
            const m = imgM || figM;
            if (m) return { url: m[1].trim(), clean: text.replace(m[0], '').trim() };
            return { url: null, clean: text };
        }

        function renderQ(q, num, marks, opts = {}) {
            const raw = q.question_text || '';
            const fig = parseFig(raw);
            let url = fig.url || q.image_url;
            let text = fig.clean;
            let html = `<div class="question"><span class="q-num">${num}.</span><div class="q-body">`;

            // Image at top
            if (url) {
                html += `<div class="figure-box"><img src="${url}" class="q-image" alt="Diagram" onerror="this.parentElement.innerHTML='<div style=\\'color:#888;font-size:0.7rem\\'>Diagram could not be loaded</div>'"></div>`;
            }

            // Assertion-Reason format
            if (opts.isAR) {
                const arParts = text.split(/Reason\s*\(R\)\s*:/i);
                const assertion = arParts[0].replace(/Assertion\s*\(A\)\s*:/i, '').trim();
                const reason = arParts[1] ? arParts[1].split(/\(a\)/i)[0].trim() : text;
                html += `<div class="assertion-block">
                    <div><span class="ar-label">Assertion (A):</span> ${assertion}</div>
                    <div><span class="ar-label">Reason (R):</span> ${reason}</div>
                    <div class="mcq-options single-col" style="margin-top:6px">
                        <div class="mcq-opt">(a) Both A and R are true and R is the correct explanation of A</div>
                        <div class="mcq-opt">(b) Both A and R are true but R is NOT the correct explanation of A</div>
                        <div class="mcq-opt">(c) A is true but R is false</div>
                        <div class="mcq-opt">(d) A is false but R is true</div>
                    </div>
                </div>`;
            }
            // MCQ with (a)(b)(c)(d) or (A)(B)(C)(D)
            else if (text.match(/\([A-Da-d]\)\s/)) {
                const upperMatch = text.match(/\(A\)/);
                const sep = upperMatch ? /\(([A-D])\)/g : /\(([a-d])\)/g;
                const firstOpt = upperMatch ? '(A)' : '(a)';
                const parts = text.split(firstOpt);
                const mainText = parts[0].trim();
                const optStr = firstOpt + (parts[1] || '');
                const options = optStr.match(upperMatch ? /\([A-D]\)[^(]*/g : /\([a-d]\)[^(]*/g);

                html += `<div>${mainText}</div>`;
                if (options) {
                    const longOpts = options.some(o => o.trim().length > 40);
                    html += `<div class="mcq-options${longOpts ? ' single-col' : ''}" style="margin-top:4px">`;
                    options.forEach(o => html += `<div class="mcq-opt">${o.trim()}</div>`);
                    html += `</div>`;
                }
            }
            // Sub-parts (i)(ii)(iii) or (a)(b)(c)
            else if (text.match(/\((i|ii|iii|iv)\)/) || text.match(/\(a\).*\(b\)/s)) {
                const subSep = text.match(/\((i)\)/) ? /\((i|ii|iii|iv|v)\)/g : /\(([a-e])\)/g;
                const firstSub = text.match(/\((i)\)/) ? '(i)' : '(a)';
                const mainPart = text.split(firstSub)[0].trim();
                const subStr = text.substring(mainPart.length);
                const subs = subStr.match(text.match(/\((i)\)/) ? /\((?:i|ii|iii|iv|v)\)[^(]*/g : /\([a-e]\)[^(]*/g);

                html += `<div>${mainPart}</div>`;
                if (subs) {
                    html += `<div class="sub-parts">`;
                    subs.forEach(s => html += `<div class="sub-part">${s.trim()}</div>`);
                    html += `</div>`;
                }
            }
            else {
                html += `<div>${text}</div>`;
            }

            html += `</div><span class="q-marks">[${marks}]</span></div>`;
            return html;
        }

        function toggleAnswers() {
            const ak = document.getElementById('answer-key-section');
            const btn = document.getElementById('ans-btn');
            if (!ak) return;
            if (ak.style.display === 'none') { ak.style.display = 'block'; btn.textContent = 'Hide Answer Key' }
            else { ak.style.display = 'none'; btn.textContent = 'Show Answer Key' }
        }

        async function createPaper() {
            const btn = document.getElementById('create-btn');
            const err = document.getElementById('error-msg');
            btn.disabled = true; btn.textContent = 'Generating...'; err.style.display = 'none';
            try {
                const bp = BLUEPRINTS[selectedSubject];
                // Fetch from both plain and composite subject names
                const [r1, r2] = await Promise.all([
                    db.from('question_bank').select('*').eq('subject', selectedSubject).limit(1000),
                    db.from('question_bank').select('*').eq('subject', `${selectedSubject}_${selectedGrade}`).limit(1000)
                ]);
                if (r1.error) throw r1.error;
                const allQ = [...(r1.data || []), ...(r2.data || [])];
                if (allQ.length === 0) throw new Error(`No questions found for ${selectedSubject}. Database may be empty.`);
                const pool = allQ.sort(() => Math.random() - 0.5);
                paperCount++;
                currentAnswers = [];

                // ===== PAPER HEADER (Exact CBSE Format) =====
                let html = `<div class="paper ${bp.lang || ''}">
                    <div class="paper-header">
                        <div class="school-line">Central Board of Secondary Education</div>
                        <div class="exam-line">ANNUAL EXAMINATION (2025-26)</div>
                        <div class="subject-line">${bp.fullName}</div>
                        <div class="code-line">Subject Code: ${bp.code} | Class: IX</div>
                    </div>
                    <div class="paper-meta">
                        <span>Time Allowed: ${bp.time}</span>
                        <span>Maximum Marks: ${bp.maxMarks}</span>
                    </div>
                    <div class="paper-meta" style="border-bottom:none;font-size:0.78rem;color:#666">
                        <span>Date: ___________</span>
                        <span>Roll No: ___________</span>
                    </div>
                    <div class="paper-instructions">
                        <strong>General Instructions:</strong>
                        <ol>`;
                bp.inst.forEach(i => html += `<li>${i}</li>`);
                html += `</ol></div>`;

                // ===== SECTIONS =====
                let gNum = 0, used = new Set();
                bp.sections.forEach(sec => {
                    // Section header with question range
                    let startQ = gNum + 1;
                    let endQ = gNum + (sec.count || 0);
                    let rangeStr = sec.count > 0 ? `(Q.${startQ} to Q.${endQ})` : '';
                    html += `<div class="section-header">${sec.title} ‚Äî ${sec.desc} ${sec.perQ > 0 ? '(' + sec.perQ + ' mark' + (sec.perQ > 1 ? 's' : '') + ' each)' : ''} <span class="q-range">${rangeStr}</span></div>`;

                    if (sec.count > 0) {
                        // Get available questions
                        let sectionPool = pool.filter(q => !used.has(q.id));
                        // Diagram bias for case studies and science LA
                        if (sec.qType === 'case' || (selectedSubject === 'Science' && sec.id === 'D')) {
                            const dP = sectionPool.filter(q => (q.question_text || '').includes('[Image:') || q.image_url);
                            const oP = sectionPool.filter(q => !((q.question_text || '').includes('[Image:') || q.image_url));
                            sectionPool = [...dP, ...oP];
                        }

                        let count = 0;
                        for (let q of sectionPool) {
                            if (selectedDiff !== 'Mixed' && q.difficulty !== selectedDiff) continue;
                            gNum++; count++; used.add(q.id);

                            // Determine if this is an Assertion-Reason question
                            const isAR = sec.hasAR && gNum >= sec.arStart && gNum <= sec.arStart + 1;

                            if (sec.qType === 'case') {
                                // Case study rendering
                                html += `<div class="question"><span class="q-num">${gNum}.</span><div class="q-body">`;
                                const fig = parseFig(q.question_text || '');
                                let caseText = fig.clean;
                                if (fig.url || q.image_url) {
                                    html += `<div class="figure-box"><img src="${fig.url || q.image_url}" class="q-image" alt="Case Study Diagram" onerror="this.parentElement.innerHTML='<div style=\\'color:#888;font-size:0.7rem\\'>Diagram could not be loaded</div>'"></div>`;
                                }
                                // Split into passage and sub-parts
                                const subMatch = caseText.match(/\((i|a)\)/);
                                if (subMatch) {
                                    const passage = caseText.substring(0, subMatch.index).trim();
                                    const subText = caseText.substring(subMatch.index);
                                    html += `<div class="case-study-intro">${passage}</div>`;
                                    const subs = subText.match(/\((?:i|ii|iii|iv|a|b|c|d)\)[^(]*/g);
                                    if (subs && sec.caseSubParts) {
                                        html += `<div class="sub-parts">`;
                                        subs.forEach((s, idx) => {
                                            const m = sec.caseSubParts[idx] || 1;
                                            html += `<div class="sub-part">${s.trim()} <span class="q-marks">[${m}]</span></div>`;
                                        });
                                        html += `</div>`;
                                    } else {
                                        html += `<div>${subText}</div>`;
                                    }
                                } else {
                                    html += `<div class="case-study-intro">${caseText}</div>`;
                                    if (sec.caseSubParts) {
                                        html += `<div class="sub-parts">`;
                                        sec.caseSubParts.forEach((m, i) => {
                                            html += `<div class="sub-part">(${String.fromCharCode(105 + i)}) [Answer based on the above passage] <span class="q-marks">[${m}]</span></div>`;
                                        });
                                        html += `</div>`;
                                    }
                                }
                                html += `</div><span class="q-marks">[${sec.perQ}]</span></div>`;
                            }
                            else if (sec.qType === 'map') {
                                html += renderQ(q, gNum, sec.perQ);
                                html += `<div style="text-align:center;padding:12px;font-style:italic;font-size:0.8rem;color:#555">Map of India attached separately ‚Äî History (2 marks) + Geography (3 marks)</div>`;
                            }
                            else {
                                html += renderQ(q, gNum, sec.perQ, { isAR });
                            }

                            // Internal choice (OR) ‚Äî show for every other question in applicable sections
                            if (sec.internalChoice && count % 2 === 0 && count < sec.count) {
                                // Find an OR alternative
                                const altQ = sectionPool.find(aq => !used.has(aq.id) && (selectedDiff === 'Mixed' || aq.difficulty === selectedDiff));
                                if (altQ) {
                                    used.add(altQ.id);
                                    html += `<div class="or-divider">OR</div>`;
                                    html += renderQ(altQ, gNum, sec.perQ);
                                }
                            }

                            // Store answer for answer key
                            if (q.answer) currentAnswers.push({ num: gNum, ans: q.answer });

                            if (count >= sec.count) break;
                        }
                    } else if (sec.fixed) {
                        // Fixed-mark sections (Literature, Writing, etc.)
                        if (sec.fixedSections) {
                            sec.fixedSections.forEach(fs => {
                                html += `<div style="font-weight:600;font-size:0.84rem;margin:12px 0 8px;padding-left:4px;border-left:3px solid var(--accent,#7c3aed);padding:4px 8px;background:#f8f8ff">${fs.label} ‚Äî ${fs.marks} Marks</div>`;
                                if (fs.count > 0 && fs.perQ > 0) {
                                    let fsCount = 0;
                                    let sectionPool = pool.filter(q => !used.has(q.id));
                                    for (let q of sectionPool) {
                                        if (selectedDiff !== 'Mixed' && q.difficulty !== selectedDiff) continue;
                                        gNum++; fsCount++; used.add(q.id);
                                        html += renderQ(q, gNum, fs.perQ);
                                        if (q.answer) currentAnswers.push({ num: gNum, ans: q.answer });

                                        if (fs.internalChoice && fsCount === fs.count) {
                                            const altQ = sectionPool.find(aq => !used.has(aq.id));
                                            if (altQ) {
                                                used.add(altQ.id);
                                                html += `<div class="or-divider">OR</div>`;
                                                html += renderQ(altQ, gNum, fs.perQ);
                                            }
                                        }
                                        if (fsCount >= fs.count) break;
                                    }
                                } else if (fs.fixedNote) {
                                    html += `<div class="fixed-section-note">${fs.fixedNote}</div>`;
                                } else {
                                    html += `<div class="fixed-section-note">Attempt questions worth ${fs.marks} marks as per the instructions given in each question.</div>`;
                                }
                            });
                        } else {
                            html += `<div class="fixed-section-note">Questions worth ${sec.fixed} marks from prescribed texts.</div>`;
                        }
                    }
                });

                // ===== ANSWER KEY (hidden by default) =====
                html += `<div class="answer-key" id="answer-key-section" style="display:none">
                    <h3>üìã Answer Key</h3><div>`;
                if (currentAnswers.length > 0) {
                    currentAnswers.forEach(a => html += `<span class="ak-item"><strong>Q.${a.num}:</strong> ${a.ans}</span>`);
                } else {
                    html += `<div style="color:#888;font-style:italic">Answer key not available for this paper.</div>`;
                }
                html += `</div></div>`;

                // End paper
                html += `<div style="text-align:center;margin-top:30px;font-size:0.8rem;color:#888;border-top:1px solid #ddd;padding-top:12px">‚Äî End of Question Paper ‚Äî</div>`;
                html += `</div>`;

                document.getElementById('paper-content').innerHTML = html;
                document.getElementById('selection-view').style.display = 'none';
                document.getElementById('paper-view').style.display = 'block';

                // Stats bar
                document.getElementById('stats-bar').innerHTML = `
                    <span>üìÑ Paper #${paperCount}</span>
                    <span>üìä ${allQ.length} questions in database</span>
                    <span>‚úÖ ${gNum} questions generated</span>
                `;
            }
            catch (e) { err.textContent = e.message; err.style.display = 'block' }
            finally { btn.disabled = false; btn.textContent = 'Generate Question Paper' }
        }
    </script>
</body>

</html>